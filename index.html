<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamHub - Ultimate Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&amp;display=swap" rel="stylesheet">
    <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: #050505; color: white; overflow-x: hidden; }
  
    /* Utilidades */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
   
    /* --- BOTONES DE CONTROL CARRUSEL --- */
    .nav-btn {
        position: absolute; top: 0; bottom: 0; z-index: 40; width: 60px;
        display: none; align-items: center; justify-content: center;
        transition: opacity 0.3s;
    }
    .nav-btn.left { left: 0; background: linear-gradient(to right, #050505 0%, transparent 100%); }
    .nav-btn.right { right: 0; background: linear-gradient(to left, #050505 0%, transparent 100%); }
    .nav-btn button {
        background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
        border-radius: 50%; width: 40px; height: 40px; border: 1px solid rgba(255,255,255,0.1);
        color: white; font-size: 20px; transition: transform 0.2s, background 0.2s;
    }
    .nav-btn button:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
    @media (min-width: 1024px) { .carousel-wrapper:hover .nav-btn { display: flex; } }
   
    /* --- ESTILOS DE TARJETAS (FEED) --- */
    .card-std { min-width: 200px; width: 200px; display: flex; flex-direction: column; gap: 10px; cursor: pointer; position: relative; }
    .card-video {
        height: 220px; width: 220px; flex-shrink: 0; position: relative; overflow: hidden; border-radius: 12px;
        transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1); cursor: pointer;
    }
    @media (min-width: 1024px) { .card-video:hover { width: 390px; } }
    .card-list-group { min-width: 340px; display: flex; flex-direction: column; gap: 16px; }
    .list-item { display: flex; align-items: center; gap: 12px; padding: 6px; border-radius: 8px; transition: background 0.2s; cursor: pointer; }
    .list-item:hover { background: rgba(255,255,255,0.08); }
   
    /* --- INTERACCIÓN --- */
    .overlay-full {
        position: absolute; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
        opacity: 0; transition: opacity 0.3s; display: flex; align-items: center; justify-content: center; gap: 12px; border-radius: 12px;
    }
    .group:hover .overlay-full { opacity: 1; }
    .overlay-mini {
        position: absolute; inset: 0; background: rgba(0,0,0,0.4); opacity: 0; transition: opacity 0.2s;
        display: flex; align-items: center; justify-content: center; border-radius: 4px;
    }
    .list-item:hover .overlay-mini { opacity: 1; }
   
    /* Iconos */
    .action-icon { width: 36px; height: 36px; transition: transform 0.2s, opacity 0.3s; cursor: pointer; pointer-events: auto; }
    .action-icon:hover { transform: scale(1.15); }
    .play-icon-lg { width: 56px; height: 56px; transition: transform 0.2s; cursor: pointer; pointer-events: auto; }
    .play-icon-lg:hover { transform: scale(1.1); }
    .play-icon-sm { 
        width: 28px; 
        height: 28px; 
        /* filter: invert(1); */ /* Comentado para que quede blanco natural */
        pointer-events: auto; 
    }
   
    /* Grid View Card */
    .grid-card { width: 100%; display: flex; flex-direction: column; gap: 10px; cursor: pointer; position: relative; }
    .grid-card .aspect-square { border-radius: 12px; overflow: hidden; position: relative; }
   
    /* BÚSQUEDA MEJORADA PARA DESKTOP */
    .desktop-search-container {
        position: relative;
    }
   
    .desktop-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: rgba(10, 10, 10, 0.98);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        margin-top: 8px;
        padding: 12px;
        max-height: 400px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
   
    .desktop-search-results.active {
        display: block;
        animation: fadeIn 0.2s ease;
    }
   
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
   
    .search-result-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
    }
   
    .search-result-item:hover {
        background: rgba(255, 255, 255, 0.1);
    }
   
    /* BOTÓN PLAY PARA MÓVIL */
    .mobile-play-button {
        position: absolute;
        bottom: 8px;
        right: 8px;
        width: 32px;
        height: 32px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 30;
        pointer-events: auto;
    }
   
    .mobile-play-button img {
        width: 16px;
        height: 16px;
        /* filter: invert(1); */  /* Comentado → ahora el ícono se ve blanco como el SVG original */
    }
   
    @media (min-width: 1024px) {
        .mobile-play-button {
            display: none;
        }
    }
   
    /* Búsqueda móvil mejorada */
    #mobileSearchBar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 9999;
        transform: translateY(-100%);
        transition: transform 0.3s ease;
    }
    #mobileSearchBar.open {
        transform: translateY(0);
    }
    .search-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        z-index: 9998;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .search-overlay.active {
        opacity: 1;
        visibility: visible;
    }
   
    /* Móvil Disable Hovers */
    @media (max-width: 1023px) {
        .overlay-full, .overlay-mini, .nav-btn { display: none !important; }
    }
</style>


    
    <div class="search-overlay" id="searchOverlay" onclick="closeSearch()"></div>
    
    
    <header id="top-header" class="sticky top-0 z-50 bg-[#050505]/80 backdrop-blur-xl border-b border-white/5">
        <div class="max-w-[1600px] mx-auto px-6 py-4 flex items-center justify-between" id="header-container">
            
            <a href="/" class="flex items-center gap-2">
                <img src="https://media.baltaanay.org/web/image/885-f3d79ca9/xhbalta-aula.png" alt="StreamHub Logo" class="w-8 h-8 rounded-lg object-cover" loading="lazy">
                <span class="text-xl font-bold text-white">Media</span>
            </a>

            
            <div class="hidden lg:flex items-center gap-4 desktop-search-container">
                <div class="relative">
                    <input type="text" id="desktopSearch" placeholder="Buscar episodios, series..." class="bg-white/10 border border-white/20 rounded-full px-4 py-2 pl-10 text-sm w-64 focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="handleDesktopSearchInput(this.value)" onkeypress="if(event.key === 'Enter') handleDesktopSearchEnter(event)" onfocus="showDesktopSearchResults()">
                    <img src="https://media.baltaanay.org/web/image/793-902e5b33/Search%20%282%29.png" alt="Buscar" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4" loading="lazy">
                </div>
                
                <div class="desktop-search-results" id="desktopSearchResults">
                    <div id="desktopSearchResultsContent"></div>
                </div>
                <a href="/my/home" class="text-sm font-bold text-gray-400 hover:text-white">Iniciar sesión</a>
            </div>

            
            <div class="flex items-center gap-4">
                <button onclick="toggleMobileSearch()" class="lg:hidden text-gray-400 hover:text-white">
                    <img src="https://media.baltaanay.org/web/image/793-902e5b33/Search%20%282%29.png" alt="Buscar" class="w-5 h-5" loading="lazy">
                </button>
                <a href="/novedades" class="relative text-gray-400 hover:text-white">
                    <img src="https://media.baltaanay.org/web/image/796-aee658de/Explore.png" alt="Notificaciones" class="w-5 h-5" loading="lazy">
                    <span class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                </a>
                <a href="/my/home" class="w-8 h-8 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full overflow-hidden">
                    <img src="https://media.baltaanay.org/web/image/793-902e5b33/Search%20%282%29.png" alt="Usuario" class="w-full h-full object-cover" loading="lazy">
                </a>
            </div>
        </div>
    </header>

    
    <div id="mobileSearchBar" class="lg:hidden bg-[#050505] p-4 border-b border-white/10">
        <div class="flex items-center gap-3">
            <img src="https://media.baltaanay.org/web/image/793-902e5b33/Search%20%282%29.png" alt="Buscar" class="w-5 h-5" loading="lazy">
            <input type="text" id="mobileSearchInput" placeholder="Buscar episodios, series..." class="flex-1 bg-transparent border-none text-white text-lg focus:outline-none placeholder-gray-500" oninput="handleMobileSearchInput(this.value)" onkeypress="if(event.key === 'Enter') handleMobileSearchEnter(event)">
            <button onclick="handleMobileSearchButton()" class="text-white px-3 py-1 bg-blue-600 rounded-md text-sm">Buscar</button>
            <button onclick="toggleMobileSearch()" class="text-white text-xl">×</button>
        </div>
        
        <div id="mobileSearchResults" class="mt-4 max-h-[60vh] overflow-y-auto"></div>
    </div>
    
    
    <div class="sticky top-0 z-40 bg-[#050505]/95 backdrop-blur-xl border-b border-white/5" id="category-filters">
        <div class="py-3 overflow-x-auto no-scrollbar">
            <div class="max-w-[1600px] mx-auto px-6 flex items-center gap-3" id="category-pills"></div>
        </div>
    </div>
    
    
    <main class="max-w-[1600px] mx-auto px-6 mt-4 min-h-screen">
        <div id="feed-view" class="space-y-12 transition-opacity duration-300">
            
        </div>
        <div id="grid-view" class="hidden transition-opacity duration-300">
            <div class="flex items-center justify-between mb-8 mt-6">
                <h2 id="grid-title" class="text-2xl font-bold">Resultados</h2>
                <button onclick="showFeed()" class="text-sm font-bold text-gray-400 hover:text-white flex items-center gap-1">
                    <span class="text-xl">×</span> Cerrar búsqueda
                </button>
            </div>
            <div id="results-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
            <div id="empty-state" class="hidden py-10 text-center">
                <p class="text-gray-400 text-lg mb-8" id="empty-msg">No encontramos nada...</p>
                <h3 class="text-xl font-bold mb-6 text-white">Quizás te interese esto:</h3>
                <div id="recommendations-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6"></div>
            </div>
        </div>
    </main>

<script>
// --- ICONOS ACTUALIZADOS ---
const ICONS = {
    play: 'https://marca1.odoo.com/web/image/508-f876320c/play.svg',
    add: 'https://marca1.odoo.com/web/image/509-c555b4ef/a%C3%B1adir%20a.svg',
    added: 'https://nikichitonjesus.odoo.com/web/image/1112-d141b3eb/a%C3%B1adido.png',
    dl: 'https://marca1.odoo.com/web/image/510-7a9035c1/descargar.svg',
    noDl: 'https://nikichitonjesus.odoo.com/web/image/1051-622a3db3/no-desc.webp'
};

// --- CATEGORÍAS EDUCATIVAS ---
const CATEGORIES = [
    "Todos",
    "Derecho",
    "Física y Astronomía",
    "Matemáticas",
    "Historia",
    "Filosofía",
    "Economía y Finanzas",
    "Ciencias Sociales",
    "Arte y Cultura",
    "Literatura y Audiolibros",
    "Cine y TV",
    "Documentales",
    "Ciencias Naturales",
    "Tecnología e Informática",
    "Otras Ciencias"
];

// --- EPISODIOS DE EJEMPLO (mejorados con cover2 para videos) ---
const USER_EPISODES = [
    { date: '2025-11-28', type: 'audio', mediaUrl: 'https://d3ctxlq1ktw2nl.cloudfront.net/staging/2025-10-29/413399242-44100-2-2f259e66aeac3.m4a', coverUrl: 'https://s3-us-west-2.amazonaws.com/anchor-generated-image-bank/staging/podcast_uploaded_nologo400/44500417/44500417-1759018829686-8b0dde55850ed.jpg', title: 'La excepción en el proceso de administración de Justicia', description: 'La excepción en el proceso de administración de Justicia', detailUrl: 'https://media.baltaanay.org/teoria-del-proceso', allowDownload: false, author: "Barahona", series: { portada_serie: 'https://media.baltaanay.org/web/image/658-redirect/960bc627aab97e6134955b4d5d1c99d0.jpg', titulo_serie: 'Teoría del proceso', descripcion_serie: 'Proceso en el derecho y la forma de poner en movimiento la maquinaria de Justicia', url_serie: 'https://media.baltaanay.org/teoria-del-proceso' } },
    { date: '2025-11-28', type: 'audio', mediaUrl: 'https://balta-derecho.odoo.com/documents/content/3L5vYn32Sq-M5sUKB96S1Ao9', coverUrl: 'https://s3-us-west-2.amazonaws.com/anchor-generated-image-bank/staging/podcast_uploaded_nologo400/44500417/44500417-1759018829686-8b0dde55850ed.jpg', title: 'Principios procesales', description: 'La excepción en el proceso de administración de Justicia', detailUrl: 'https://media.baltaanay.org/teoria-del-proceso', allowDownload: false, author: "Barahona", series: { portada_serie: 'https://media.baltaanay.org/web/image/658-redirect/960bc627aab97e6134955b4d5d1c99d0.jpg', titulo_serie: 'Teoría del proceso', descripcion_serie: 'Proceso en el derecho y la forma de poner en movimiento la maquinaria de Justicia', url_serie: 'https://media.baltaanay.org/teoria-del-proceso' } },
    { date: '2025-11-01', type: 'video', mediaUrl: 'https://lb.s3.odysee.tv/vods2.odysee.live/odysee-replays/84515919a2e010fa2c381702a6777c1035c2deb3/1762812470.mp4', coverUrl: 'https://balta.odoo.com/web/image/417-e2fd48e0/media.webp', title: 'Responsabilidad penal en la adolecencia', description: 'Conferencia de Derechos Humanos. Sobre la responsabilidad penal de la adolecencia, las penas y las medidas de seguridad.', detailUrl: '/ddhh/adolecencia', allowDownload: false, author: "Rony Eulalio", series: { portada_serie: 'https://scout.es/wp-content/uploads/2021/12/186-01.jpg', titulo_serie: 'Derechos Humanos', descripcion_serie: 'Derechos Humanos', url_serie: '/ddhh' } },
    { date: '2025-11-01', type: 'video', mediaUrl: 'https://lb.s3.odysee.tv/vods2.odysee.live/odysee-replays/84515919a2e010fa2c381702a6777c1035c2deb3/1762807738.mp4', coverUrl: 'https://balta.odoo.com/web/image/417-e2fd48e0/media.webp', title: 'Repaso de DD Procesal Constitucional', description: 'Penultima clase de Derecho Procesal Constitucional 2025', detailUrl: '/procesal-constitucional', allowDownload: false, author: "César Solares", series: { portada_serie: 'https://balta.odoo.com/web/image/417-e2fd48e0/media.webp', titulo_serie: 'Derecho Procesal Constitucional', descripcion_serie: 'Derecho Procesal Constitucional', url_serie: '/procesal-constitucional' } },
    {
date: '2026-02-10',
                mediaUrl: "https://d3ctxlq1ktw2nl.cloudfront.net/staging/2026-1-13/418061888-44100-2-bd0c488cd9ace.m4a",
                type: "audio",
				coverUrl: 'https://media.baltaanay.org/web/image/925-6ed84678/DERECHO%20PENAL%20III.png',
                title: "Corrientes de la teoría del delito",
                detailUrl: "ddpp-3/clases",
                author: "Lemus",
                text: "Continuación de las corrientes de la teoría del delito. Teoría causalista, finalista y funcionalista.",
                allowDownload: false,
                coverUrl: "https://s3-us-west-2.amazonaws.com/anchor-generated-image-bank/staging/podcast_uploaded_episode400/44500417/44500417-1769910530363-7e96ebf855644.jpg", 
series: { 
            portada_serie: 'https://media.baltaanay.org/web/image/925-6ed84678/DERECHO%20PENAL%20III.png', 
            titulo_serie: 'Derecho penal 3', 
            descripcion_serie: 'Derecho Público', 
            url_serie: 'ddpp-3/clases' 
        }
            },
            {
date: '2026-02-03',
                mediaUrl: "https://lb.s3.odysee.tv/vods2.odysee.live/odysee-replays/dd57d90536480f9a751ba4429447fd5f613efce3/1770150346.mp4",
                type: "video",
				coverUrl: 'https://media.baltaanay.org/web/image/925-6ed84678/DERECHO%20PENAL%20III.png',
				title: "La teoría causalista",
                detailUrl: "ddpp-3/clases",
                author: "Lemus",
                text: "Desarrollo de la teoría causalista. Derecho Penal 3. Historia, Ciencia.",
                allowDownload: false,
                coverUrl: "https://s3-us-west-2.amazonaws.com/anchor-generated-image-bank/staging/podcast_uploaded_episode400/44500417/44500417-1769910530363-7e96ebf855644.jpg", 
series: { 
            portada_serie: 'https://media.baltaanay.org/web/image/925-6ed84678/DERECHO%20PENAL%20III.png', 
            titulo_serie: 'Derecho penal 3', 
            descripcion_serie: 'Derecho Público', 
            url_serie: 'ddpp-3/clases' 
        }
            },
            {
date: '2026-01-29',
                mediaUrl: "https://podcasts.com/api/download-episode/214790939",
                type: "audio",
				coverUrl: 'https://media.baltaanay.org/web/image/925-6ed84678/DERECHO%20PENAL%20III.png',
                title: "¿Qué es el Derecho Penal?",
                author: "Lemus",
                text: "Conjunto de normas jurídicas de naturaleza pública que regulan los delitos, las penas y las medidas de seguridad. Ciencia pública. Derecho, Historia.",
                allowDownload: false,
                detailUrl: "ddpp-3/clases",
                coverUrlInfo: "https://media.baltaanay.org/web/image/925-6ed84678/DERECHO%20PENAL%20III.png", 
series: { 
            portada_serie: 'https://media.baltaanay.org/web/image/925-6ed84678/DERECHO%20PENAL%20III.png', 
            titulo_serie: 'Derecho penal 3', 
            descripcion_serie: 'Derecho Público', 
            url_serie: 'ddpp-3/clases' 
        }
            },
            {
date: '2026-02-12',
            mediaUrl: "https://d3ctxlq1ktw2nl.cloudfront.net/staging/2026-1-13/418069738-44100-2-616f210f1eb48.m4a",
            type: "audio",
            coverUrl: 'https://media.baltaanay.org/web/image/925-6ed84678/DERECHO%20PENAL%20III.png',
			title: "La tipicidad y los elementos del delito",
            detailUrl: "ddpp-3/clases",
            author: "Lemus",
            text: "Análisis profundo del concepto de tipicidad en derecho y sociedad. Una mirada crítica y actual. Ciencia.",
            allowDownload: false, 
series: { 
            portada_serie: 'https://media.baltaanay.org/web/image/925-6ed84678/DERECHO%20PENAL%20III.png', 
            titulo_serie: 'Derecho penal 3', 
            descripcion_serie: 'Derecho Público', 
            url_serie: 'ddpp-3/clases' 
        }
        },
{
date: '2026-02-06',
            mediaUrl: "https://d3ctxlq1ktw2nl.cloudfront.net/staging/2026-1-13/418064713-44100-2-ed2c58b07cd6.m4a",
            type: "audio",
            coverUrl: 'https://media.baltaanay.org/web/image/927-edc793ab/Pueblos%20ind%C3%ADgenas.png',
			title: "Crisis del Estado de Derecho",
            detailUrl: "/dp-indigenas",
            author: "Raymundo",
            text: "La crisis del Estado de Derecho. Por Lic. Raymundo Catz. El estado de derecho en crisis por los derechos de segunda y tercera generación.",
            allowDownload: false, 
series: { 
            portada_serie: 'https://media.baltaanay.org/web/image/927-edc793ab/Pueblos%20ind%C3%ADgenas.png', 
            titulo_serie: 'Derecho de los pueblos indígenas', 
            descripcion_serie: 'Los derechos de tercera generación. Desarrolla los derechos de los pueblos indígenas o también conocidos como derechos de solidaridad.', 
            url_serie: 'dp-indigenas' 
        }},
{
            date: '2026-02-04',
			mediaUrl: "https://lb.s3.odysee.tv/vods2.odysee.live/odysee-replays/dd57d90536480f9a751ba4429447fd5f613efce3/1770236623.mp4",
            type: "video",
			coverUrl: 'https://media.baltaanay.org/web/image/927-edc793ab/Pueblos%20ind%C3%ADgenas.png',
            title: "Conceptos básicos de los Derechos Humanos",
            detailUrl: "/dp-indigenas",
            author: "Raymundo",
            text: "Conceptos básicos de los Derechos Humanos",
            allowDownload: false, 
series: { 
            portada_serie: 'https://media.baltaanay.org/web/image/927-edc793ab/Pueblos%20ind%C3%ADgenas.png', 
            titulo_serie: 'Derecho de los pueblos indígenas', 
            descripcion_serie: 'Los derechos de tercera generación. Desarrolla los derechos de los pueblos indígenas o también conocidos como derechos de solidaridad. Ciencias Sociales. Historia.', 
            url_serie: 'dp-indigenas' 
        }},
{ 
        date: '2026-02-02', 
        type: 'video', 
        mediaUrl: 'https://d3ctxlq1ktw2nl.cloudfront.net/staging/2026-1-2/417347225-44100-2-38463f72786e9.m4a', 
        coverUrl: 'https://media.baltaanay.org/web/image/929-b905c3ef/DERECHO%20LABORAL.png', 
        coverUrl2: 'https://media.baltaanay.org/web/image/929-b905c3ef/DERECHO%20LABORAL.png', // Cover2 para video expandido
        title: 'Antecedentes Históricos del derecho de Trabajo', 
        description: 'Antecedentes históricos del derecho de trabajo. Avidan Ortiz. Historia del derecho Laboral.', 
        detailUrl: '/derecho-laboral-1', 
        allowDownload: false,
        author: "Avidan Ortiz", 
        series: { 
            portada_serie: 'https://media.baltaanay.org/web/image/929-b905c3ef/DERECHO%20LABORAL.png', 
            titulo_serie: 'Derecho Laboral', 
            descripcion_serie: 'Un derecho humano por excelencia. Es la ciencia, una disciplina pública. Ciencias Sociales.', 
            url_serie: 'URL_SERIE' 
        } 
    },
{ 
        date: '2026-02-06', 
        type: 'video', 
        mediaUrl: 'https://d3ctxlq1ktw2nl.cloudfront.net/staging/2026-1-13/ca5f6f25-3b96-ff31-bb04-e712a81ce076.m4a', 
        coverUrl: 'https://media.baltaanay.org/web/image/929-b905c3ef/DERECHO%20LABORAL.png', 
        coverUrl2: 'https://media.baltaanay.org/web/image/929-b905c3ef/DERECHO%20LABORAL.png', // Cover2 para video expandido
        title: 'Fuentes del Derecho de Trabajo', 
        description: 'Historia. Fuentes del Derecho de trabajo. Ciencia.', 
        detailUrl: '/derecho-laboral-1', 
        allowDownload: false,
        author: "Avidan Ortiz", 
        series: { 
            portada_serie: 'https://media.baltaanay.org/web/image/929-b905c3ef/DERECHO%20LABORAL.png', 
            titulo_serie: 'Derecho Laboral', 
            descripcion_serie: 'Un derecho humano por excelencia. Es la ciencia, una disciplina pública. Ciencias Sociales.', 
            url_serie: 'URL_SERIE' 
        } 
    },
    { date: '2025-09-27', type: 'audio', mediaUrl: 'https://d3ctxlq1ktw2nl.cloudfront.net/staging/2025-8-28/408260699-44100-2-4b5edeb875805.m4a', coverUrl: 'https://s3-us-west-2.amazonaws.com/anchor-generated-image-bank/staging/podcast_uploaded_episode400/44500417/44500417-1759018710643-950caadc41ea7.jpg', title: 'Veliz Franco y Otros Vs. Guatemala - Exposición', description: 'Guatemala presentaba un alto índice de impunidad general, en cuyo marco la mayoría de los actos violentos que conllevaban la muerte de mujeres quedaban impunes.', detailUrl: 'https://media.baltaanay.org/dh/caso-veliz-franco-vs-guatemala', allowDownload: true, author: "Melany y Laura", series: { portada_serie: 'https://scout.es/wp-content/uploads/2021/12/186-01.jpg', titulo_serie: 'Derechos Humanos', descripcion_serie: 'Derechos humanos', url_serie: '/ddhh' } },
    
];

// --- SISTEMA DE PLAYLIST MEJORADO ---
const playlistKey = 'streamhub_userPlaylist';
let userPlaylist = JSON.parse(localStorage.getItem(playlistKey)) || [];

// Función mejorada para agregar a playlist
function addToUserPlaylist(episodeData) {
    if (!episodeData || !episodeData.mediaUrl) {
        console.error("Faltan datos del episodio para agregar a la playlist");
        return false;
    }
    
    const exists = userPlaylist.some(item => item.mediaUrl === episodeData.mediaUrl);
    
    if (!exists) {
        const playlistItem = {
            mediaUrl: episodeData.mediaUrl,
            mediaType: episodeData.type || episodeData.mediaType || 'audio',
            coverUrlContainer: episodeData.cover || episodeData.coverUrlContainer || episodeData.coverUrl,
            coverUrlInfo: episodeData.cover || episodeData.coverUrlInfo || episodeData.coverUrl,
            title: episodeData.title,
            detailUrl: episodeData.detailUrl || '#',
            author: episodeData.author || 'Desconocido',
            next: [],
            text: episodeData.description || '',
            allowDownload: episodeData.allowDownload !== undefined ? episodeData.allowDownload : true
        };
        
        userPlaylist.push(playlistItem);
        localStorage.setItem(playlistKey, JSON.stringify(userPlaylist));
        
        updateAddButtons(episodeData.id || episodeData.mediaUrl);
        
        return true;
    }
    
    return false;
}

// Actualizar iconos de agregar
function updateAddButtons(identifier) {
    const buttons = document.querySelectorAll(`[data-episode-id="${identifier}"], [data-media-url="${identifier}"]`);
    buttons.forEach(btn => {
        if (btn.dataset.added !== 'true') {
            if (btn.tagName === 'IMG') {
                btn.src = ICONS.added;
            }
            btn.dataset.added = 'true';
            btn.title = 'Añadido a tu lista';
        }
    });
}

// Verificar si un episodio está en la playlist
function isInPlaylist(mediaUrl) {
    return userPlaylist.some(item => item.mediaUrl === mediaUrl);
}

// --- PROCESAMIENTO DE DATOS ---
function determineCategories(ep) {
    const cats = new Set();
    const text = (ep.title + ' ' + ep.description + ' ' + (ep.series?.titulo_serie || '') + ' ' + (ep.series?.descripcion_serie || '')).toLowerCase();

    const patterns = {
        "Derecho": /\b(derecho|penal|civil|constitucional|procesal|delito|ley|jurisprudencia|código|tribunal|justicia|proceso)\b/i,
        "Física y Astronomía": /\b(física|fisica|mecánica|mecanica|cuántica|cuantica|termodinámica|termodinamica|newton|einstein|astronomía|astronomia|planeta|cosmos)\b/i,
        "Matemáticas": /\b(matemática|matematicas|calculo|cálculo|algebra|álgebra|geometria|geometría|estadistica|estadística|probabilidad|ecuacion|ecuación|teorema|integral)\b/i,
        "Historia": /\b(historia|histórico|historico|siglo|época|epoca|imperio|guerra|revolución|revolucion|antiguo|medieval)\b/i,
        "Filosofía": /\b(filosofía|filosofia|kant|platon|platón|aristoteles|ética|etica|metafísica|metafisica|ontología|ontologia|epistemología|epistemologia)\b/i,
        "Economía y Finanzas": /\b(economía|economia|finanzas|inflación|inflacion|keynes|oferta|demanda|macroeconomía|macroeconomia|pib|mercado)\b/i,
        "Ciencias Sociales": /\b(sociología|sociologia|antropología|antropologia|psicología|psicologia|sociedad|cultura|identidad|género|genero|desigualdad)\b/i,
        "Arte y Cultura": /\b(arte|pintura|escultura|arquitectura|renacimiento|barroco|música|musica|cultura|artístico|artistico)\b/i,
        "Literatura y Audiolibros": /\b(audiolibro|libro|novela|cuento|poema|clásico|clasico|literatura|lectura)\b/i,
        "Cine y TV": /\b(cine|película|pelicula|serie|director|guion|ficción|ficcion|animación|animacion)\b/i,
        "Documentales": /\b(documental|bbc|ciencia|naturaleza|espacio|universo|planeta|nacional geographic)\b/i,
        "Ciencias Naturales": /\b(biología|biologia|química|quimica|geología|geologia|ecología|ecologia|evolución|evolucion|genética|genetica|clima|botánica|botanica)\b/i,
        "Tecnología e Informática": /\b(tecnología|tecnologia|programación|programacion|python|ia|computación|computacion|algoritmo|software|desarrollo)\b/i
    };

    for (const [cat, regex] of Object.entries(patterns)) {
        if (regex.test(text)) cats.add(cat);
    }

    if (ep.type === 'video') {
        if (text.includes('documental')) cats.add("Documentales");
        else cats.add("Cine y TV");
    }

    if (cats.size === 0) cats.add("Otras Ciencias");

    return Array.from(cats);
}

const DATA = USER_EPISODES.map((ep, i) => ({
    id: i,
    title: ep.title,
    author: ep.author || ep.series?.titulo_serie || 'Conferencias Académicas',
    categories: determineCategories(ep),
    cover: ep.coverUrl,
    coverWide: ep.coverUrl2 || ep.coverUrl, // Usa coverUrl2 si existe y no es false
    mediaUrl: ep.mediaUrl,
    type: ep.type,
    description: ep.description + ' ' + (ep.series?.descripcion_serie || ''),
    allowDownload: ep.allowDownload !== undefined ? ep.allowDownload : true,
    detailUrl: ep.detailUrl,
    date: ep.date,
    series: ep.series
}));

// --- VARIABLES GLOBALES ---
let currentView = 'feed';
let lastScrollTop = 0; // VARIABLE DECLARADA CORRECTAMENTE
let searchTimeout = null;
let lastSearchQuery = '';

// --- BÚSQUEDA MEJORADA DESKTOP ---
function showDesktopSearchResults() {
    const results = document.getElementById('desktopSearchResults');
    results.classList.add('active');
}

function hideDesktopSearchResults() {
    setTimeout(() => {
        const results = document.getElementById('desktopSearchResults');
        if (results) {
            results.classList.remove('active');
        }
    }, 200);
}

function handleDesktopSearchInput(query) {
    clearTimeout(searchTimeout);
    
    if (!query || query.trim() === '') {
        clearDesktopSearchResults();
        return;
    }
    
    searchTimeout = setTimeout(() => {
        const results = performQuickSearch(query);
        renderDesktopSearchResults(results, query);
    }, 300);
}

function handleDesktopSearchEnter(event) {
    event.preventDefault();
    const query = document.getElementById('desktopSearch').value.trim();
    if (query) {
        performFullSearch(query);
        hideDesktopSearchResults();
    }
}

function performQuickSearch(query) {
    const term = query.toLowerCase().trim();
    return DATA.filter(ep =>
        ep.title.toLowerCase().includes(term) ||
        ep.author.toLowerCase().includes(term) ||
        ep.categories.some(c => c.toLowerCase().includes(term)) ||
        ep.description.toLowerCase().includes(term)
    ).slice(0, 5);
}

function renderDesktopSearchResults(results, query) {
    const container = document.getElementById('desktopSearchResultsContent');
    if (!container) return;
    
    if (results.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-gray-400">
                <p>No encontramos resultados para "${query}"</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = results.map(ep => `
        <div class="search-result-item" onclick="goToDetailFromSearch('${ep.detailUrl}', event)">
            <div class="w-12 h-12 rounded-md overflow-hidden flex-shrink-0">
                <img src="${ep.cover}" class="w-full h-full object-cover">
            </div>
            <div class="flex-1 min-w-0">
                <h4 class="font-bold text-sm text-white truncate">${ep.title}</h4>
                <p class="text-xs text-gray-400 truncate">${ep.author} • ${ep.type === 'video' ? 'Video' : 'Audio'}</p>
            </div>
        </div>
    `).join('');
    
    // Agregar opción para ver todos los resultados
    container.innerHTML += `
        <div class="search-result-item mt-2 border-t border-white/10 pt-2" onclick="performFullSearch('${query}', event)">
            <div class="flex items-center justify-center w-full">
                <span class="text-blue-400 font-bold text-sm">Ver todos los resultados para "${query}"</span>
            </div>
        </div>
    `;
}

function goToDetailFromSearch(url, event) {
    event.stopPropagation();
    event.preventDefault();
    window.location.href = url; // Misma pestaña
}

function performFullSearch(query, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    performSearch(query);
    hideDesktopSearchResults();
}

function clearDesktopSearchResults() {
    const container = document.getElementById('desktopSearchResultsContent');
    if (container) {
        container.innerHTML = '';
    }
    const results = document.getElementById('desktopSearchResults');
    if (results) {
        results.classList.remove('active');
    }
}

// --- BÚSQUEDA MÓVIL ---
function handleMobileSearchInput(query) {
    clearTimeout(searchTimeout);
    
    if (!query || query.trim() === '') {
        clearMobileSearchResults();
        return;
    }
    
    searchTimeout = setTimeout(() => {
        const results = performQuickSearch(query);
        renderMobileSearchResults(results, query);
    }, 300);
}

function handleMobileSearchEnter(event) {
    event.preventDefault();
    const query = document.getElementById('mobileSearchInput').value.trim();
    if (query) {
        handleMobileSearch(query);
    }
}

function handleMobileSearchButton() {
    const query = document.getElementById('mobileSearchInput').value.trim();
    if (query) {
        handleMobileSearch(query);
    }
}

function renderMobileSearchResults(results, query) {
    const container = document.getElementById('mobileSearchResults');
    if (!container) return;
    
    if (results.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-gray-400">
                <p>No encontramos resultados para "${query}"</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = results.map(ep => `
        <div class="search-result-item" onclick="goToDetailFromSearch('${ep.detailUrl}', event)">
            <div class="w-12 h-12 rounded-md overflow-hidden flex-shrink-0">
                <img src="${ep.cover}" class="w-full h-full object-cover">
            </div>
            <div class="flex-1 min-w-0">
                <h4 class="font-bold text-sm text-white truncate">${ep.title}</h4>
                <p class="text-xs text-gray-400 truncate">${ep.author} • ${ep.type === 'video' ? 'Video' : 'Audio'}</p>
            </div>
        </div>
    `).join('');
    
    // Agregar opción para ver todos los resultados
    container.innerHTML += `
        <div class="search-result-item mt-2 border-t border-white/10 pt-2" onclick="handleMobileSearch('${query}')">
            <div class="flex items-center justify-center w-full">
                <span class="text-blue-400 font-bold text-sm">Ver todos los resultados para "${query}"</span>
            </div>
        </div>
    `;
}

function clearMobileSearchResults() {
    const container = document.getElementById('mobileSearchResults');
    if (container) {
        container.innerHTML = '';
    }
}

function toggleMobileSearch() {
    const el = document.getElementById('mobileSearchBar');
    const overlay = document.getElementById('searchOverlay');
    
    if (el.classList.contains('open')) {
        el.classList.remove('open');
        overlay.classList.remove('active');
        document.getElementById('mobileSearchInput').value = '';
        clearMobileSearchResults();
    } else {
        el.classList.add('open');
        overlay.classList.add('active');
        document.getElementById('mobileSearchInput').focus();
    }
}

function handleMobileSearch(query) {
    const input = document.getElementById('mobileSearchInput');
    const searchQuery = query || input.value.trim();
    
    if (searchQuery) {
        performSearch(searchQuery);
        closeSearch();
    }
}

function closeSearch() {
    const mobileBar = document.getElementById('mobileSearchBar');
    const overlay = document.getElementById('searchOverlay');
    
    if (mobileBar && mobileBar.classList.contains('open')) {
        mobileBar.classList.remove('open');
    }
    
    if (overlay) {
        overlay.classList.remove('active');
    }
    
    const desktopSearch = document.getElementById('desktopSearch');
    if (desktopSearch) {
        desktopSearch.blur();
    }
    
    clearDesktopSearchResults();
    clearMobileSearchResults();
}

// --- NAVEGACIÓN Y VISTAS ---
function toggleView(view) {
    const feed = document.getElementById('feed-view');
    const grid = document.getElementById('grid-view');
    if (view === 'grid') {
        feed.classList.add('hidden');
        grid.classList.remove('hidden');
        window.scrollTo(0, 0);
    } else {
        feed.classList.remove('hidden');
        grid.classList.add('hidden');
        const desktopSearch = document.getElementById('desktopSearch');
        if (desktopSearch) desktopSearch.value = '';
        const mobileInput = document.getElementById('mobileSearchInput');
        if (mobileInput) mobileInput.value = '';
        renderCategoryPills('Todos');
    }
    currentView = view;
}

function showFeed() { 
    toggleView('feed'); 
    closeSearch();
}

function performSearch(query) {
    if (!query || query.trim() === '') { 
        showFeed(); 
        return; 
    }
    
    const term = query.toLowerCase().trim();
    lastSearchQuery = query;
    
    let results = DATA.filter(ep =>
        ep.title.toLowerCase().includes(term) ||
        ep.author.toLowerCase().includes(term) ||
        ep.categories.some(c => c.toLowerCase().includes(term)) ||
        ep.description.toLowerCase().includes(term)
    );

    renderGrid(results, `Resultados para "${query}"`);
}

function filterByCategory(cat) {
    renderCategoryPills(cat);
    if (cat === 'Todos') { 
        showFeed(); 
        return; 
    }
    const results = DATA.filter(ep => ep.categories.includes(cat));
    renderGrid(results, cat);
}

// --- RENDER GRID Y CARDS MEJORADOS ---
function renderGrid(items, title) {
    toggleView('grid');
    const gridContainer = document.getElementById('results-grid');
    const emptyState = document.getElementById('empty-state');
    const titleEl = document.getElementById('grid-title');
    titleEl.innerText = title;
    gridContainer.innerHTML = '';
    
    if (items.length === 0) {
        emptyState.classList.remove('hidden');
        gridContainer.classList.add('hidden');
        const searchTerm = title.replace('Resultados para ', '').replace(/"/g, '');
        document.getElementById('empty-msg').innerText = `No hemos encontrado nada para "${searchTerm}"`;
        
        const suggestions = [...DATA].sort(() => 0.5 - Math.random()).slice(0, 5);
        const recGrid = document.getElementById('recommendations-grid');
        recGrid.innerHTML = '';
        suggestions.forEach(ep => recGrid.innerHTML += createGridCard(ep));
    } else {
        emptyState.classList.add('hidden');
        gridContainer.classList.remove('hidden');
        items.forEach(item => {
            gridContainer.innerHTML += createGridCard(item);
        });
    }
}

function createGridCard(item) {
    const isInPlaylistItem = isInPlaylist(item.mediaUrl);
    const addIcon = isInPlaylistItem ? ICONS.added : ICONS.add;
    const dlIcon = item.allowDownload ? ICONS.dl : ICONS.noDl;
    
    return `
        <div class="grid-card group">
            <div class="aspect-square bg-zinc-800 relative" onclick="goToDetail('${item.detailUrl}')">
                <img src="${item.cover}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                <div class="overlay-full">
                    <img src="${addIcon}" class="action-icon" onclick="handleAdd(event, ${item.id}); return false;" 
                         data-episode-id="${item.id}" data-added="${isInPlaylistItem}">
                    <img src="${ICONS.play}" class="play-icon-lg" onclick="handlePlay(event, ${item.id}); return false;">
                    <img src="${dlIcon}" class="action-icon" onclick="handleDl(event, ${item.id}); return false;" 
                         title="${item.allowDownload ? 'Descargar' : 'Descarga no disponible'}">
                </div>
                <!-- Botón play para móvil -->
                <div class="mobile-play-button" onclick="handlePlay(event, ${item.id}); return false;">
                    <img src="${ICONS.play}" alt="Play">
                </div>
            </div>
            <div onclick="goToDetail('${item.detailUrl}')">
                <h4 class="font-bold text-sm text-white truncate">${item.title}</h4>
                <p class="text-xs text-gray-500 truncate">${item.author}</p>
            </div>
        </div>
    `;
}

function renderCategoryPills(activeCat = 'Todos') {
    const container = document.getElementById('category-pills');
    if (!container) return;
    
    container.innerHTML = '';
    CATEGORIES.forEach(cat => {
        const isActive = cat === activeCat;
        const btn = document.createElement('button');
        btn.className = `whitespace-nowrap px-4 py-1.5 rounded-full text-xs font-bold transition-all ${isActive ? 'bg-white text-black' : 'bg-white/10 text-gray-300 hover:bg-white/20'}`;
        btn.innerText = cat;
        btn.onclick = () => filterByCategory(cat);
        container.appendChild(btn);
    });
}

// --- COMPONENTES DE TARJETAS MEJORADOS ---
function createStandardCard(ep) {
    const isInPlaylistItem = isInPlaylist(ep.mediaUrl);
    const addIcon = isInPlaylistItem ? ICONS.added : ICONS.add;
    const dlIcon = ep.allowDownload ? ICONS.dl : ICONS.noDl;
    
    return `<div class="card-std group">
        <div class="relative w-full aspect-square rounded-xl overflow-hidden bg-zinc-800" onclick="goToDetail('${ep.detailUrl}')">
            <img src="${ep.cover}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
            <div class="overlay-full">
                <img src="${addIcon}" class="action-icon" onclick="handleAdd(event, ${ep.id}); return false;" 
                     data-episode-id="${ep.id}" data-added="${isInPlaylistItem}">
                <img src="${ICONS.play}" class="play-icon-lg" onclick="handlePlay(event, ${ep.id}); return false;">
                <img src="${dlIcon}" class="action-icon" onclick="handleDl(event, ${ep.id}); return false;" 
                     title="${ep.allowDownload ? 'Descargar' : 'Descarga no disponible'}">
            </div>
            <!-- Botón play para móvil -->
            <div class="mobile-play-button" onclick="handlePlay(event, ${ep.id}); return false;">
                <img src="${ICONS.play}" alt="Play">
            </div>
        </div>
        <div onclick="goToDetail('${ep.detailUrl}')">
            <h3 class="font-bold text-white text-sm truncate">${ep.title}</h3>
            <p class="text-xs text-gray-400 mt-1 truncate">${ep.author}</p>
        </div>
    </div>`;
}

// --- TARJETA DE VIDEO EXPANDIBLE CON COVER 2 ---
function createVideoExpand(ep) {
    const isInPlaylistItem = isInPlaylist(ep.mediaUrl);
    const addIcon = isInPlaylistItem ? ICONS.added : ICONS.add;
    const dlIcon = ep.allowDownload ? ICONS.dl : ICONS.noDl;
    const hasCover2 = ep.coverWide && ep.coverWide !== ep.cover;
    
    return `<div class="card-video group">
        <!-- Miniatura 1 (cuadrada) - visible por defecto -->
        <img src="${ep.cover}" class="absolute inset-0 w-full h-full object-cover z-10 group-hover:opacity-0 transition-opacity duration-300">
        
        <!-- Miniatura 2 (ancha) - visible en hover solo si existe -->
        ${hasCover2 ? `
        <img src="${ep.coverWide}" class="absolute inset-0 w-full h-full object-cover opacity-0 group-hover:opacity-100 transition-opacity duration-300">
        ` : ''}
        
        <div class="overlay-full z-20">
            <img src="${addIcon}" class="action-icon" onclick="handleAdd(event, ${ep.id}); return false;" 
                 data-episode-id="${ep.id}" data-added="${isInPlaylistItem}">
            <img src="${ICONS.play}" class="play-icon-lg" onclick="handlePlay(event, ${ep.id}); return false;">
            <img src="${dlIcon}" class="action-icon" onclick="handleDl(event, ${ep.id}); return false;" 
                 title="${ep.allowDownload ? 'Descargar' : 'Descarga no disponible'}">
        </div>
        <!-- Botón play para móvil -->
        <div class="mobile-play-button z-30" onclick="handlePlay(event, ${ep.id}); return false;">
            <img src="${ICONS.play}" alt="Play">
        </div>
        <div class="absolute bottom-2 left-2 z-20 bg-black/60 px-2 py-0.5 rounded text-[10px] font-bold">VIDEO</div>
    </div>`;
}

function createListItem(ep, idx) {
    const isInPlaylistItem = isInPlaylist(ep.mediaUrl);
    const addIcon = isInPlaylistItem ? ICONS.added : ICONS.add;
    
    return `<div class="list-item group">
        <span class="text-gray-500 font-bold w-4 text-center text-sm">${idx + 1}</span>
        <div class="relative w-14 h-14 flex-shrink-0 rounded overflow-hidden" onclick="goToDetail('${ep.detailUrl}')">
            <img src="${ep.cover}" class="w-full h-full object-cover">
            <div class="overlay-mini" onclick="handlePlay(event, ${ep.id}); return false;"><img src="${ICONS.play}" class="play-icon-sm"></div>
        </div>
        <div class="flex-1 min-w-0" onclick="goToDetail('${ep.detailUrl}')">
            <h4 class="font-bold text-sm truncate text-white">${ep.title}</h4>
            <p class="text-xs text-gray-500 truncate">${ep.author}</p>
        </div>
        <button class="hidden lg:group-hover:block opacity-60 hover:opacity-100 pr-2" onclick="handleAdd(event, ${ep.id}); return false;">
            <img src="${addIcon}" alt="Agregar" class="w-5 h-5" data-episode-id="${ep.id}" data-added="${isInPlaylistItem}">
        </button>
        <!-- Botón play para móvil (en lista) -->
        <div class="lg:hidden mobile-play-button" style="position: static; margin-right: 8px;" onclick="handlePlay(event, ${ep.id}); return false;">
            <img src="${ICONS.play}" alt="Play" class="w-4 h-4">
        </div>
    </div>`;
}

// --- CARRUSEL GENÉRICO ---
function createCarousel(title, type, items, categoryContext) {
    if (!items || items.length === 0) return '';
    
    const id = 'c-' + Math.random().toString(36).substr(2, 9);
    let content = '';
    
    if (type === 'double') {
        content = `<div id="${id}" class="flex flex-col flex-wrap h-[580px] gap-x-6 gap-y-6 overflow-x-auto no-scrollbar scroll-smooth">` + 
                  items.map(ep => createStandardCard(ep)).join('') + 
                  `</div>`;
    } else if (type === 'list') {
        content = `<div id="${id}" class="flex gap-8 overflow-x-auto no-scrollbar scroll-smooth pb-4">`;
        for (let i = 0; i < items.length; i += 4) {
            content += `<div class="card-list-group">` +
                (items[i] ? createListItem(items[i], i) : '') +
                (items[i+1] ? createListItem(items[i+1], i+1) : '') +
                (items[i+2] ? createListItem(items[i+2], i+2) : '') +
                (items[i+3] ? createListItem(items[i+3], i+3) : '') +
                `</div>`;
        }
        content += `</div>`;
    } else if (type === 'expand') {
        content = `<div id="${id}" class="flex gap-4 overflow-x-auto no-scrollbar scroll-smooth py-2 pl-1">` + 
                  items.map(ep => createVideoExpand(ep)).join('') + 
                  `</div>`;
    } else {
        content = `<div id="${id}" class="flex gap-6 overflow-x-auto no-scrollbar scroll-smooth py-2 pl-1">` + 
                  items.map(ep => createStandardCard(ep)).join('') + 
                  `</div>`;
    }
    
    return `<section class="carousel-wrapper relative group/section">
        <div class="flex items-end justify-between mb-5 px-1">
            <h2 class="text-2xl font-bold tracking-tight text-white hover:text-blue-500 transition-colors">${title}</h2>
            <button onclick="filterByCategory('${categoryContext}')" class="text-xs font-bold text-gray-500 uppercase tracking-wider hover:text-white">Ver todo</button>
        </div>
        <div class="relative">
            <div class="nav-btn left" onclick="document.getElementById('${id}').scrollLeft -= 600"><button>❮</button></div>
            ${content}
            <div class="nav-btn right" onclick="document.getElementById('${id}').scrollLeft += 600"><button>❯</button></div>
        </div>
    </section>`;
}

// --- CARRUSEL DE SERIES ---
function createSeriesCarousel() {
    const id = 'c-series-' + Math.random().toString(36).substr(2, 9);
    const seriesGroups = {};
    DATA.forEach(ep => {
        if (ep.series && ep.series.titulo_serie) {
            const serieKey = ep.series.titulo_serie;
            if (!seriesGroups[serieKey]) {
                seriesGroups[serieKey] = {episodes: [], seriesInfo: ep.series};
            }
            seriesGroups[serieKey].episodes.push(ep);
        }
    });
    
    const seriesKeys = Object.keys(seriesGroups);
    if (seriesKeys.length === 0) return '';
    
    let content = `<div id="${id}" class="flex gap-8 overflow-x-auto no-scrollbar scroll-smooth pb-4">`;
    
    seriesKeys.forEach(serieKey => {
        let group = seriesGroups[serieKey];
        group.episodes.sort((a, b) => new Date(b.date) - new Date(a.date));
        const s = group.seriesInfo;
        if (!s || group.episodes.length < 1) return;
        
        content += `<div class="card-list-group">
            <div class="mb-4 cursor-pointer" onclick="goToDetail('${s.url_serie}')">
                <div class="relative w-full aspect-square rounded-xl overflow-hidden bg-zinc-800">
                    <img src="${s.portada_serie}" class="w-full h-full object-cover">
                </div>
                <h3 class="font-bold text-white text-sm truncate mt-2">${s.titulo_serie}</h3>
                <p class="text-xs text-gray-400">ver serie</p>
            </div>`;
        
        group.episodes.slice(0, 4).forEach((ep, i) => {
            content += createListItem(ep, i);
        });
        
        content += `</div>`;
    });
    
    content += `</div>`;
    
    return `<section class="carousel-wrapper relative group/section">
        <div class="flex items-end justify-between mb-5 px-1">
            <h2 class="text-2xl font-bold tracking-tight text-white hover:text-blue-500 transition-colors">Series y Cursos Académicos</h2>
            <button class="text-xs font-bold text-gray-500 uppercase tracking-wider hover:text-white">Ver todo</button>
        </div>
        <div class="relative">
            <div class="nav-btn left" onclick="document.getElementById('${id}').scrollLeft -= 600"><button>❮</button></div>
            ${content}
            <div class="nav-btn right" onclick="document.getElementById('${id}').scrollLeft += 600"><button>❯</button></div>
        </div>
    </section>`;
}

// --- HANDLERS MEJORADOS ---
function handlePlay(e, id) {
    e.stopPropagation();
    e.preventDefault();
    const ep = DATA.find(x => x.id == id);
    
    if (typeof window.playEpisodeExpanded === 'function') {
        window.playEpisodeExpanded(
            ep.mediaUrl, 
            ep.type, 
            ep.cover, 
            ep.cover, 
            ep.title, 
            ep.detailUrl, 
            ep.author, 
            [], 
            ep.description, 
            ep.allowDownload
        );
    } else {
        // Solo intentar descargar si hay reproductor externo
        handleDl(e, id);
    }
    return false;
}

function handleAdd(e, id) {
    e.stopPropagation();
    e.preventDefault();
    const ep = DATA.find(x => x.id == id);
    const button = e.target.closest('img') || e.target;
    
    const agregado = addToUserPlaylist({
        mediaUrl: ep.mediaUrl,
        type: ep.type,
        cover: ep.cover,
        title: ep.title,
        detailUrl: ep.detailUrl,
        author: ep.author,
        description: ep.description,
        allowDownload: ep.allowDownload,
        id: ep.id
    });
    
    if (agregado) {
        if (button.tagName === 'IMG') {
            button.src = ICONS.added;
        }
        button.dataset.added = 'true';
        if (button.parentElement) {
            button.parentElement.title = 'Añadido a tu lista';
        }
        
        button.style.transform = 'scale(1.2)';
        setTimeout(() => {
            button.style.transform = 'scale(1)';
        }, 200);
    }
    
    return false;
}

function handleDl(e, id) {
    e.stopPropagation();
    e.preventDefault();
    const ep = DATA.find(x => x.id == id);
    
    if (!ep.allowDownload) {
        alert('La descarga no está disponible para este episodio');
        return false;
    }
    
    const ext = ep.type === 'video' ? 'mp4' : 'mp3';
    const filename = `${ep.title.replace(/[^a-z0-9]/gi, '_').substring(0, 50)}.${ext}`;
    
    try {
        const a = document.createElement('a');
        a.href = ep.mediaUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        // Si la descarga falla (no empieza con blob), abrir en nueva pestaña
        setTimeout(() => {
            if (!a.href.startsWith('blob:')) {
                window.open(ep.mediaUrl, '_blank');
            }
        }, 1000);
        
    } catch (error) {
        console.error('Error en descarga:', error);
        // Fallback: abrir en nueva pestaña
        window.open(ep.mediaUrl, '_blank');
    }
    
    return false;
}

function goToDetail(url) {
    if (url && url !== '#') {
        window.location.href = url; // MISMA PESTAÑA
    }
}

// --- SCROLL HEADER (CORREGIDO) ---
window.addEventListener('scroll', () => {
    const st = window.pageYOffset || document.documentElement.scrollTop;
    const topHeader = document.getElementById('top-header');
    const mobileSearch = document.getElementById('mobileSearchBar');
    
    // Verificar si los elementos existen
    if (!topHeader || !mobileSearch) {
        return;
    }
    
    if (st > lastScrollTop && st > 100) {
        topHeader.style.transition = 'opacity 0.3s ease';
        topHeader.style.opacity = '0';
        topHeader.style.pointerEvents = 'none';
        mobileSearch.style.transition = 'opacity 0.3s ease';
        mobileSearch.style.opacity = '0';
        mobileSearch.style.pointerEvents = 'none';
    } else {
        topHeader.style.opacity = '1';
        topHeader.style.pointerEvents = 'auto';
        mobileSearch.style.opacity = '1';
        mobileSearch.style.pointerEvents = 'auto';
    }
    lastScrollTop = st <= 0 ? 0 : st;
}, false);

// --- INICIALIZACIÓN ---
function init() {
    console.log('Inicializando StreamHub...');
    
    // Verificar datos
    if (!DATA || DATA.length === 0) {
        console.error('No hay datos para mostrar');
        const feedView = document.getElementById('feed-view');
        if (feedView) {
            feedView.innerHTML = 
                '<div class="text-center py-20"><p class="text-gray-400 text-lg">No hay contenido disponible en este momento.</p></div>';
        }
        return;
    }
    
    // Renderizar categorías
    renderCategoryPills();
    
    const feed = document.getElementById('feed-view');
    if (!feed) return;
    
    // Función segura para obtener elementos aleatorios
    const getRandomSafe = (count, filterFn = () => true) => {
        const filtered = DATA.filter(filterFn);
        if (filtered.length === 0) return [];
        
        const shuffled = [...filtered].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, Math.min(count, shuffled.length));
    };
    
    // Limpiar feed
    feed.innerHTML = '';
    
    // AGREGAR TODOS LOS CARRUSELES SOLICITADOS
    feed.innerHTML += createCarousel("Nuevos Lanzamientos", "standard", 
        getRandomSafe(15), "Todos");
    
    feed.innerHTML += createCarousel("Series de Video", "expand", 
        getRandomSafe(10, e => e.type === 'video'), "Cine y TV");
    
    feed.innerHTML += createCarousel("Top Semanal", "list", 
        getRandomSafe(16), "Todos");
    
    feed.innerHTML += createCarousel("Para Estudiar Profundamente", "double", 
        getRandomSafe(20), "Matemáticas");
    
    feed.innerHTML += createCarousel("Matemáticas", "standard", 
        getRandomSafe(15, e => e.categories.includes("Matemáticas")), "Matemáticas");
    
    feed.innerHTML += createCarousel("Especiales en Video", "expand", 
        getRandomSafe(10, e => e.type === 'video'), "Documentales");
    
    feed.innerHTML += createCarousel("Física y Astronomía", "standard", 
        getRandomSafe(15, e => e.categories.includes("Física y Astronomía")), "Física y Astronomía");
    
    feed.innerHTML += createCarousel("Ciencias Naturales y Tecnología", "double", 
        getRandomSafe(20, e => e.categories.some(c => 
            ["Ciencias Naturales", "Tecnología e Informática"].includes(c))), "Otras Ciencias");
    
    feed.innerHTML += createSeriesCarousel();
    
    feed.innerHTML += createCarousel("Otras Ciencias y Disciplinas", "standard", 
        getRandomSafe(15, e => e.categories.includes("Otras Ciencias") || 
            e.categories.some(c => ["Ciencias Naturales", "Tecnología e Informática"].includes(c))), 
        "Otras Ciencias");
    
    console.log('StreamHub inicializado correctamente');
}

// Inicializar cuando el DOM esté listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}

// --- FUNCIONES GLOBALES PARA USO EXTERNO ---
window.StreamHub = {
    addToPlaylist: addToUserPlaylist,
    playEpisode: function(episodeData) {
        if (typeof window.playEpisodeExpanded === 'function') {
            window.playEpisodeExpanded(
                episodeData.mediaUrl, 
                episodeData.type || 'audio', 
                episodeData.cover || episodeData.coverUrlContainer, 
                episodeData.cover || episodeData.coverUrlInfo, 
                episodeData.title, 
                episodeData.detailUrl || '#', 
                episodeData.author || 'Desconocido', 
                [], 
                episodeData.description || episodeData.text || '', 
                episodeData.allowDownload !== undefined ? episodeData.allowDownload : true
            );
        } else {
            window.location.href = episodeData.detailUrl || episodeData.mediaUrl;
        }
    }
};

</script>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Reproductor Universal</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #111 !important; color: white !important; }
.player-universal { display: none; position: fixed; bottom: 0; width: 100%; z-index: 1001; }
.player-expanded {
  background: #333 !important;
  height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
  box-sizing: border-box;
  position: fixed;
  top: env(safe-area-inset-top);
  left: 0;
  right: 0;
  overflow-y: auto;
  z-index: 1001;
}
.content-wrapper {
  display: flex;
  flex-direction: column;
  width: 100%;
  max-width: 300px;
  flex-grow: 1;
}
.complex2, .complex3 { width: 100%; }
.player-minimized {
  background: #222;
  height: 60px;
  display: flex;
  align-items: center;
  padding: 10px;
  justify-content: space-between;
  box-sizing: border-box;
  position: relative;
  cursor: pointer;
}
.player-hidden { display: none; }
.top-controls {
  display: flex;
  justify-content: space-between;
  width: 100%;
  max-width: 300px;
  margin-bottom: 10px;
}
/* Estilo base del toggle */
.media-mode-toggle {
  background: #444;
  border: none;
  border-radius: 20px;
  padding: 8px 12px;
  color: white;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  white-space: nowrap;
  transition: all 0.3s ease;
  opacity: 1;
}

/* Estado desactivado: solo audio, no hay video disponible */
.media-mode-toggle.disabled {
  opacity: 0.5;
  background: #333;
  cursor: not-allowed;
  pointer-events: none; /* Impide clics */
}

/* Resaltar el modo activo cuando hay video */
.media-mode-toggle.audio.active-left {
  background: linear-gradient(to right, #ff0000 50%, #444 50%);
}
.media-mode-toggle.video.active-right {
  background: linear-gradient(to right, #444 50%, #ff0000 50%);
}

/* Texto dentro del botón */
.mode-left, .mode-right {
  padding: 0 8px;
  transition: color 0.3s ease;
}

/* Cuando está desactivado, texto de video tenue */
.media-mode-toggle.disabled .mode-right {
  color: #888;
}

/* Cuando está activo (solo aplica si no disabled) */
.media-mode-toggle:not(.disabled) .mode-left.active,
.media-mode-toggle:not(.disabled) .mode-right.active {
  font-weight: bold;
  color: white;
}
.minimize-btn {
  background: rgba(0, 0, 0, 0.5);
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 1003;
}
.minimize-btn img { width: 24px; height: 24px; }
.player-hidden { display: none; }
.media-container {
  width: 100%;
  background: #000;
  position: relative;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 10px;
  aspect-ratio: 16 / 9;
  -webkit-tap-highlight-color: transparent;
}
.media-container video, .media-container img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  z-index: 1000;
  border-radius: 10px;
}
.media-container .overlay-gradient {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.3) 100%);
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  opacity: 0;
  transition: opacity 0.3s;
  z-index: 1001;
}
.media-container.show-controls .overlay-gradient { opacity: 1; }
.media-controls-center { display: flex; justify-content: center; align-items: center; flex-grow: 1; }
.media-controls-bottom { display: flex; justify-content: flex-end; padding: 10px; }
.fullscreen-controls {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: none;
  flex-direction: column;
  justify-content: space-between;
  z-index: 1002;
  background: linear-gradient(to bottom, rgba(0,0,0,0.5) 0%, transparent 10%, transparent 90%, rgba(0,0,0,0.5) 100%);
}
.fullscreen-title { color: white; font-size: 18px; font-weight: bold; text-align: center; padding: 10px; background: transparent; }
.fullscreen-center-controls { display: flex; justify-content: center; align-items: center; gap: 20px; }
.fullscreen-bottom-bar { display: flex; align-items: center; padding: 10px; background: transparent; }
.video-progress-container-fullscreen { flex-grow: 1; height: 6px; background: #555; border-radius: 3px; position: relative; cursor: pointer; }
.progress-bar-fullscreen { height: 100%; background: #ff0000; width: 0; border-radius: 3px; position: relative; }
.progress-knob-fullscreen {
  position: absolute;
  right: -8px;
  top: 50%;
  width: 16px;
  height: 16px;
  background: #ff0000;
  border-radius: 50%;
  transform: translateY(-50%) scale(0);
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  transition: transform 0.2s ease, opacity 0.2s ease;
  opacity: 0;
  pointer-events: none;
}
.video-progress-container-fullscreen:hover .progress-knob-fullscreen,
.video-progress-container-fullscreen.dragging .progress-knob-fullscreen { transform: translateY(-50%) scale(1); opacity: 1; }
#currentTimeFullscreen, #durationFullscreen { color: white; font-size: 12px; margin: 0 5px; }
.seek-indicator-left, .seek-indicator-right {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.7);
  padding: 10px;
  border-radius: 5px;
  color: white;
  display: flex;
  align-items: center;
  gap: 5px;
  opacity: 0;
  transition: opacity 0.3s;
  z-index: 1003;
}
.seek-indicator-left { left: 10px; }
.seek-indicator-right { right: 10px; }
.seek-indicator-left.show, .seek-indicator-right.show { opacity: 1; }
.seek-indicator-left img, .seek-indicator-right img { width: 32px; height: 32px; }
.volume-btn, .fullscreen-btn, .control-btn {
  background: rgba(0,0,0,0.5);
  border: none;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 1001;
  transition: background 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.volume-btn img, .fullscreen-btn img, .control-btn img { width: 32px; height: 32px; }
.video-progress-container-expanded {
  width: 100%;
  height: 6px;
  background: #555;
  border-radius: 3px;
  position: relative;
  cursor: pointer;
  transition: height 0.2s ease;
  margin: 2px 0;
}
.video-progress-container-expanded:hover { height: 8px; }
.progress-bar-expanded { height: 100%; background: #ff0000; width: 0; border-radius: 3px; position: relative; transition: width 0.1s ease; }
.progress-knob-expanded {
  position: absolute;
  right: -8px;
  top: 50%;
  width: 16px;
  height: 16px;
  background: #ff0000;
  border-radius: 50%;
  transform: translateY(-50%) scale(0);
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  transition: transform 0.2s ease, opacity 0.2s ease;
  opacity: 0;
  pointer-events: none;
}
.video-progress-container-expanded:hover .progress-knob-expanded,
.video-progress-container-expanded.dragging .progress-knob-expanded { transform: translateY(-50%) scale(1); opacity: 1; }
.progress-bar-expanded::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  width: 100%;
  background: linear-gradient(90deg, rgba(255,255,255,0.3) 0%, transparent 100%);
  border-radius: 3px;
}
.video-progress-container-minimized {
  width: 100%;
  height: 6px;
  background: #555;
  border-radius: 3px;
  position: absolute;
  top: 0;
  left: 0;
  margin: 0;
  cursor: pointer;
  transition: height 0.2s ease;
}
.video-progress-container-minimized:hover { height: 8px; }
.progress-bar-minimized { height: 100%; background: #ff0000; width: 0; border-radius: 3px; position: relative; transition: width 0.1s ease; }
.progress-knob-minimized {
  position: absolute;
  right: -8px;
  top: 50%;
  width: 16px;
  height: 16px;
  background: #ff0000;
  border-radius: 50%;
  transform: translateY(-50%) scale(0);
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  transition: transform 0.2s ease, opacity 0.2s ease;
  opacity: 0;
  pointer-events: none;
}
.video-progress-container-minimized:hover .progress-knob-minimized,
.video-progress-container-minimized.dragging .progress-knob-minimized { transform: translateY(-50%) scale(1); opacity: 1; }
.progress-bar-minimized::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  width: 100%;
  background: linear-gradient(90deg, rgba(255,255,255,0.3) 0%, transparent 100%);
  border-radius: 3px;
}
.controls { display: flex; justify-content: center; align-items: center; width: 100%; margin: 2px 0; gap: 5px; }
.controls button, .minimized-controls button, #minimizeBtn {
  background: transparent;
  border: none;
  padding: 0;
  margin: 0;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  -webkit-tap-highlight-color: transparent;
}
.controls img, .minimized-controls img, .action-buttons img { width: 24px; height: 24px; user-select: none; -webkit-user-select: none; pointer-events: none; }
.controls #rewindExpanded img, .controls #forwardExpanded img { width: 35px; height: 35px; } /* Aumentado 10% */
.controls #previousExpanded img, .controls #nextExpanded img { width: 33px; height: 33px; } /* Aumentado 10% */
.controls #playPauseExpanded img { width: 49px; height: 49px; } /* Aumentado 10% */
.minimized-controls #playPauseMinimized img { width: 24px; height: 24px; }
#timerIcon, #speedIcon, #previousIcon, #nextIcon { width: 28px; height: 28px; }
.episode-info {
  display: flex;
  align-items: center;
  color: white !important;
  background: transparent !important;   /* o #111 para igualarlo exactamente */
  margin: 10px 0 5px 0;
  cursor: pointer;
  width: 100%;
  position: relative;
}
.left-section { flex: 0 0 50px; }
.center-section { flex: 1; overflow: hidden; padding: 0 10px; }
.right-section { flex: 0 0 50px; text-align: right; }
.episode-info img { width: 40px; height: 40px; z-index: 3; user-select: none; }
.episode-info .center-section span { font-size: 18px; font-weight: bold; white-space: nowrap; color: white !important; display: block; }
.episode-info .center-section .author { font-size: 14px; font-weight: normal; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: white !important; }
.episode-info .scrolling-title { display: inline-block; animation: scrollTitle 40s linear infinite; }
@keyframes scrollTitle { 0%, 20% { transform: translateX(0); } 80% { transform: translateX(-100%); } 80.01% { transform: translateX(100%); } 100% { transform: translateX(0); } }
.episode-info #addToPlaylistBtn {
  background: transparent;
  border: none;
  border-radius: 5px;
  padding: 5px;
  cursor: pointer;
  transition: transform 0.2s ease;
}
.episode-info #addToPlaylistBtn img { width: 20px; height: 20px; transition: transform 0.2s ease; user-select: none; }
.episode-info #addToPlaylistBtn:active img { transform: scale(1.2); }
.time-info { display: flex; justify-content: space-between; width: 100%; color: white; margin: 0 0 5px 0; font-size: 12px; }
.minimized-controls { display: flex; align-items: center; gap: 10px; background: #222; padding: 5px; border-radius: 5px; }
.action-buttons-container { width: 100%; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; margin-bottom: 5px; }
.action-buttons-container::-webkit-scrollbar { display: none; }
.action-buttons { display: flex; gap: 10px; padding: 5px 0; }
.action-btn {
  background: #444;
  color: white;
  border: none;
  border-radius: 15px;
  padding: 6px 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 5px;
  white-space: nowrap;
  min-width: fit-content;
  transition: transform 0.2s ease;
}
.action-btn:active { transform: scale(0.95); }
.action-btn img { width: 15px; height: 15px; user-select: none; }
.action-btn.disabled { opacity: 0.5; cursor: not-allowed; }
.action-btn.disabled img { filter: grayscale(1); }
.program-container { width: 100%; margin-top: 5px; margin-bottom: 5px; }
.full-width-btn {
  width: 100%;
  display: flex;
  align-items: center;
  background: #666;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 6px;
  cursor: pointer;
  transition: background 0.2s;
}
.full-width-btn:hover { background: #777; }
.full-width-btn img { width: 20px; height: 20px; user-select: none; }
.full-width-btn span { margin-left: 10px; font-size: 16px; }
.tabs-text { width: 100%; display: flex; justify-content: space-around; margin-top: 5px; margin-bottom: 5px; }
.tabs-text a {
  color: #edebeb;
  font-weight: bold;
  text-decoration: none;
  cursor: pointer;
  font-size: 14px;
  padding: 8px 12px;
  border-radius: 8px;
  transition: background 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.tabs-text a:active { background: rgba(255,255,255,0.1); transform: scale(0.95); }
.timer-container, .speed-container {
  position: relative;
  display: flex;
  align-items: center;
  gap: 5px;
}
.timer-container.active, .speed-container.active { background: #ff0000; border-radius: 5px; padding: 2px; }
.speed-container:active, .timer-container:active { transform: scale(0.9); }
.panel-container {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 60vh;
  background: rgba(0, 0, 0, 0.9);
  z-index: 1004;
  display: none;
  flex-direction: column;
  padding: 10px;
  box-sizing: border-box;
  overflow: hidden;
}
.panel-container.full-height { height: 100vh; }
.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  padding-top: 60px !important;
  padding-left: 20px !important;
  padding-right: 20px !important;
  justify-content: center !important;
}
.tabs { display: flex; gap: 10px; }
.tabs a {
  color: #edebeb;
  font-weight: bold;
  text-decoration: none;
  cursor: pointer;
  font-size: 14px;
}
.tabs a.active { color: #ff0000; }
.panel-header button { background: transparent; border: none; cursor: pointer; border-radius: 50%; z-index: 1004; }
.panel-header button img { width: 24px; height: 24px; user-select: none; }
.panel-content { flex-grow: 1; overflow-y: auto; }
.panel-section { display: none; }
.panel-section.active { display: block; }
#viewAllLikes { background: #555; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-bottom: 10px; }
.likes-view.carousel .likes-carousel { display: flex; overflow-x: auto; gap: 10px; scrollbar-width: none; -ms-overflow-style: none; }
.likes-view.carousel .likes-carousel::-webkit-scrollbar { display: none; }
.likes-view.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 10px;
  overflow-y: auto;
}
.likes-view.grid .likes-item { flex: none; width: 100%; height: auto; }
.likes-carousel { display: flex; overflow-x: auto; gap: 10px; scrollbar-width: none; -ms-overflow-style: none; }
.likes-carousel::-webkit-scrollbar { display: none; }
.likes-item {
  flex: 0 0 100px;
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  padding: 5px;
  border-radius: 8px;
  transition: background 0.2s;
}
.likes-item:hover { background: #555; }
.likes-item img { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; user-select: none; }
.likes-item span { color: #edebeb; font-size: 12px; text-align: center; margin-top: 5px; }
.playlist-items, .next-items, .recomendados-items { overflow-y: auto; flex-grow: 1; }
.playlist-item, .next-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 5px;
  cursor: pointer;
  border-bottom: 1px solid #555;
  height: 50px;
}
.playlist-item:hover, .next-item:hover { background: #555; }
.playlist-item.active, .next-item.active { background: #555; }
.playlist-item img.cover, .next-item img.cover { width: 40px; height: 40px; margin-right: 10px; user-select: none; }
.playlist-item span, .next-item span { flex-grow: 1; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #edebeb; }
.playlist-item .item-controls, .next-item .item-controls { display: flex; gap: 5px; }
.playlist-item button, .next-item button { background: transparent; border: none; cursor: pointer; border-radius: 50%; }
.playlist-item button img, .next-item button img { width: 20px; height: 20px; user-select: none; }
.playlist-item .item-play-pause img { width: 20px; height: 20px; }
.playlist-item .drag-handle { cursor: grab; }
.playlist-item .drag-handle img { width: 18px !important; height: 18px !important; opacity: 0.8; user-select: none; }
.playlist-item .item-controls { display: flex; gap: 8px; align-items: center; }
.separator { margin: 10px 0; }
.separator h4 { color: #edebeb; font-size: 16px; }
.text-content { overflow-y: auto; flex-grow: 1; color: #edebeb; font-size: 14px; }
.text-content h4 { margin: 0 0 10px 0; }
.no-items { color: #edebeb; text-align: center; margin-top: 20px; }
#playUserPlaylistBtn { background: #0c5db3; color: #edebeb; border: none; padding: 8px; border-radius: 5px; cursor: pointer; margin-top: 10px; width: 100%; transition: background 0.2s; }
#playUserPlaylistBtn:hover { background: #0d6ecd; }
#playUserPlaylistBtn.active { background: #006400; }
.minimized-content { display: flex; align-items: center; width: calc(100% - 20px); position: absolute; top: 15px; left: 10px; }
.minimized-cover { flex: 0 0 40px; }
.minimized-cover img { width: 40px !important; height: 40px !important; object-fit: cover; border-radius: 5px; display: block; }
.minimized-title-container { flex: 1; overflow: hidden; padding: 0 10px; }
.minimized-title { font-size: 16px; font-weight: bold; color: white; white-space: nowrap; }
.minimized-title.scrolling { display: inline-block; animation: scrollMinimizedTitle 20s linear infinite; }
@keyframes scrollMinimizedTitle { 0%, 10% { transform: translateX(0); } 90% { transform: translateX(-100%); } 90.01% { transform: translateX(100%); } 100% { transform: translateX(0); } }
@media (max-width: 768px) {
  .media-container {
    aspect-ratio: 1 / 1 !important; /* Cuadrado para mejor uso vertical en móvil */
    max-height: none !important; /* Permite que crezca según el espacio disponible */
    width: 100% !important; /* Asegura full-width */
    height: auto !important; /* Deja que el alto se adapte al aspect-ratio */
  }
  .player-expanded {
    padding: 10px;
    padding-top: calc(env(safe-area-inset-top) + 10px);
    padding-bottom: calc(env(safe-area-inset-bottom) + 10px);
    display: flex;
    flex-direction: column;
    justify-content: flex-start; /* Alinea al top para mejor uso vertical */
  }
  .content-wrapper {
    max-width: 100% !important; /* Elimina encapsulamiento */
    width: 100% !important;
    gap: 20px !important; /* Más espacio vertical entre secciones */
    padding: 0 10px !important; /* Padding lateral mínimo para no tocar bordes */
    flex-grow: 1; /* Permite crecer verticalmente */
  }
  .complex2 {
    flex: 0 0 auto !important; /* No crece innecesariamente, pero se adapta */
    width: 100% !important;
  }
  /* Asegura que no haya scroll horizontal */
  body, .player-expanded, .content-wrapper {
    overflow-x: hidden !important; /* Evita scroll horizontal */
    box-sizing: border-box !important;
  }
}
    
    @media (max-width: 768px) {
  .top-controls, .content-wrapper, .episode-info, .controls, .action-buttons-container, .time-info, .video-progress-container-expanded, .program-container, .tabs-text {
    max-width: 100% !important; /* Full-width en móvil */
    width: 100% !important;
  }
  .player-expanded {
    width: 100vw !important; /* Usa viewport width para full-screen feel */
    height: 100vh !important;
    left: 0 !important;
    right: 0 !important;
    box-sizing: border-box !important;
  }
  /* Ajustes extra para elementos internos */
  .complex3 > div {
    margin-bottom: 16px !important; /* Más espacio vertical, como ya tenías */
  }
  .action-buttons-container {
    overflow-x: auto !important; /* Permite scroll horizontal solo si botones son muchos, pero no fuerza */
    scrollbar-width: none !important; /* Oculta scrollbar para clean look */
  }
}
    .player-expanded .content-wrapper {
  justify-content: flex-start !important; /* Alinea todo al top */
  height: auto !important; /* Deja que crezca según contenido */
}
.media-container {
  flex: 1 1 auto !important; /* Permite que el media crezca verticalmente si es cuadrado */
}
@media (min-width: 601px) {
  .content-wrapper { align-items: center; }
  .media-container { aspect-ratio: 16 / 9; max-height: calc(100vh - 200px); }
}
@media (min-width: 769px) {
  .content-wrapper { flex-direction: row; max-width: 100%; gap: 20px; align-items: center; justify-content: center; }
  .complex2 { width: 60%; max-width: 60%; }
  .complex3 { width: 40%; max-width: 40%; overflow-y: auto; max-height: calc(100vh - 100px); }
  .panel-container { width: 40%; right: 0; left: auto; }
  .video-progress-container-expanded, .controls, .action-buttons-container, .episode-info, .time-info, .program-container, .tabs-text { width: 100%; max-width: none; }
}
.player-expanded {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  width: 100% !important;
  height: 100vh !important;
  padding: max(12px, env(safe-area-inset-top)) 10px max(20px, env(safe-area-inset-bottom)) 10px !important;
  background: #111 !important;
  z-index: 2147483647 !important;
  overflow-y: auto;
  overscroll-behavior: contain;
  box-sizing: border-box;
  flex-direction: column;
  gap: 5px;
}
.player-expanded .media-container { flex: 1 1 auto; min-height: 0; margin: 0 !important; max-height: none !important; aspect-ratio: 16 / 9 !important; }
.player-expanded #minimizeBtn { position: fixed !important; top: max(12px, env(safe-area-inset-top)) !important; right: 12px !important; z-index: 1003 !important; background: rgba(0,0,0,0.7) !important; backdrop-filter: blur(10px); }
.player-expanded #closePanelBtn { z-index: 1004 !important; }
img { user-select: none; -webkit-user-select: none; pointer-events: none; }
*, *:active, *:focus { -webkit-tap-highlight-color: transparent; -webkit-tap-highlight-color: rgba(0,0,0,0); outline: none; }
.episode-info, #addToPlaylistBtn, #addToPlaylistBtn img, .tabs-text a, .action-btn, .full-width-btn { -webkit-tap-highlight-color: transparent !important; }
.mute-indicator { position: absolute; bottom: 20px; right: 60px; background: rgba(255,0,0,0.7); color: white; padding: 5px 10px; border-radius: 5px; z-index: 1003; }
.media-controls-center { justify-content: center; }
.control-btn { align-self: center; }
.fullscreen-center-controls { height: 100% !important; display: flex !important; justify-content: center !important; align-items: center !important; gap: 20px; }
.media-controls-center { flex-grow: 1; display: flex; justify-content: center; align-items: center; }
/* Evita solapamiento si overlay no oculto */
.fullscreen-controls.active .overlay-gradient { opacity: 0; }

.overlay-gradient, .fullscreen-controls { transition: opacity 0.3s ease !important; }
.media-container:not(.show-controls) .overlay-gradient, .fullscreen-controls:not(.show-controls) { opacity: 0 !important; pointer-events: none !important; }
.media-container.show-controls .overlay-gradient, .fullscreen-controls.show-controls { opacity: 1 !important; pointer-events: auto !important; }
.fullscreen-controls { background: transparent !important; opacity: 1 !important; }
.fullscreen-controls { 
  background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 20%, transparent 30%, transparent 70%, rgba(0,0,0,0.3) 80%, rgba(0,0,0,0.7) 100%) !important;
  background-image: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 20%, transparent 30%, transparent 70%, rgba(0,0,0,0.3) 80%, rgba(0,0,0,0.7) 100%), linear-gradient(to right, rgba(0,0,0,0.4) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.4) 100%) !important;
  transition: background 0.3s ease, opacity 0.3s ease !important;
}
.fullscreen-controls:not(.show-controls) { background: transparent !important; }
#exitFullscreenBtn { pointer-events: auto !important; z-index: 1007 !important; }
@media (min-width: 769px) {
  .content-wrapper { justify-content: center; align-items: center; height: 100%; }
}
    
   .tabs a {
  display: none; /* Inicialmente ocultos, JS los muestra por grupo */
}

.tabs a.visible {
  display: inline-block; /* Muestra solo los del grupo */
} 
    
    .panel-header {
  display: flex !important;
  justify-content: space-between !important;
  align-items: center !important;
  padding: 20px 20px 10px 20px !important;
  margin-bottom: 0 !important;
  position: relative;
  z-index: 1004;
}

.tabs {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}

.tabs a {
  color: white !important;
  font-size: 20px !important;
  font-weight: bold !important;
  text-decoration: none;
  padding: 8px 12px;
  border-radius: 8px;
  transition: background 0.2s;
}

.tabs a.active {
  color: #ff0000 !important;
  background: rgba(255, 0, 0, 0.2);
}

.tabs a.visible {
  display: inline-block;
}

.panel-controls {
  display: flex;
  gap: 10px;
  align-items: center;
}

#togglePanelHeightBtn,
#closePanelBtn {
  background: rgba(0, 0, 0, 0.7) !important;
  backdrop-filter: blur(10px);
  border-radius: 50% !important;
  width: 44px !important;
  height: 44px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  border: none;
  cursor: pointer;
  transition: transform 0.2s ease;
}

#togglePanelHeightBtn:hover,
#closePanelBtn:hover {
  transform: scale(1.1);
}

#togglePanelHeightBtn img,
#closePanelBtn img {
  width: 28px !important;
  height: 28px !important;
}

/* Ocultar el botón cerrar que estaba fuera del panel */
#closePanelBtn {
  position: static !important;
  opacity: 1 !important;
  visibility: visible !important;
  pointer-events: auto !important;
}
    /* Temporizador vertical y alternado */
.timer-options {
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  gap: 10px !important;
  padding: 10px !important;
}

.timer-options button {
  width: 100% !important;
  padding: 12px !important;
  border-radius: 8px !important;
  font-size: 18px !important;
  color: white !important;
  border: none !important;
  cursor: pointer !important;
  transition: background 0.2s !important;
}

.timer-options button:nth-child(odd) {
  background: #444 !important; /* Gris oscuro */
}

.timer-options button:nth-child(even) {
  background: #555 !important; /* Gris claro */
}

.timer-options button.selected {
  background: #ff0000 !important; /* Rojo para seleccionado */
  color: white !important;
}

/* Contador y botón desactivar */
#timerCountdown {
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  gap: 15px !important;
  padding: 20px !important;
}

#countdownDisplay {
  font-size: 48px !important;
  font-weight: bold !important;
  color: white !important;
}

#deactivateTimer {
  background: white !important;
  color: #111 !important;
  padding: 12px 20px !important;
  border-radius: 8px !important;
  font-size: 16px !important;
  border: none !important;
  cursor: pointer !important;
  transition: background 0.2s !important;
}

#deactivateTimer:hover {
  background: #eee !important;
}
    /* Velocidad: valor arriba, slider ancho/delgado */
#velocidadContent .options-panel {
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  gap: 15px !important;
  padding: 20px !important;
}

#currentSpeed {
  font-size: 32px !important;
  font-weight: bold !important;
  color: white !important;
}

#speedSlider {
  width: 100% !important;
  height: 4px !important; /* Delgado */
  background: #ccc !important; /* Gris claro */
  appearance: none !important;
  border-radius: 2px !important;
  cursor: pointer !important;
}

#speedSlider::-webkit-slider-thumb {
  appearance: none !important;
  width: 20px !important;
  height: 20px !important;
  background: white !important; /* Círculo blanco */
  border-radius: 50% !important;
  border: 2px solid #ff0000 !important; /* Borde rojo para resaltar */
  transition: transform 0.2s !important;
}

#speedSlider::-webkit-slider-thumb:hover,
#speedSlider:active::-webkit-slider-thumb {
  transform: scale(1.2) !important;
}

.speed-labels {
  display: flex !important;
  justify-content: space-between !important;
  width: 100% !important;
  font-size: 14px !important;
  color: #ddd !important;
}
    @media (max-width: 600px) {
  .panel-header {
    padding: 10px 10px 5px 10px !important; /* Menos padding */
  }

  .tabs {
    gap: 10px !important; /* Menos espacio entre tabs */
  }

  .tabs a {
    font-size: 14px !important; /* Más pequeño */
    padding: 6px 8px !important;
  }

  .panel-controls button {
    width: 36px !important;
    height: 36px !important;
  }

  .panel-controls button img {
    width: 20px !important;
    height: 20px !important;
  }
}
 #timerCountdown, #timerOptions {
  width: 100%;
}

/* Asegurar que el oculto no afecte layout */
#timerCountdown[style*="none"], #timerOptions[style*="none"] {
  display: none !important;
}
@media (max-width: 600px) {
  /* 1. Más espacio vertical en complex3 */
  .complex3 > div {
    margin-bottom: 16px !important; /* Separación entre bloques */
  }

  /* Separación extra específica para algunos elementos */
  .video-progress-container-expanded { margin-bottom: 8px !important; }
  .time-info { margin-bottom: 12px !important; }
  .controls { margin-bottom: 16px !important; }
  .action-buttons-container { margin-bottom: 16px !important; }
  .program-container { margin-bottom: 16px !important; }
  .tabs-text { margin-bottom: 10px !important; margin-top: 10px !important; }

  /* 2. Hacer media-container cuadrado en móvil */
  .media-container {
    aspect-ratio: 1 / 1 !important; /* Cuadrado */
    max-height: none !important;    /* Permite crecer */
  }

  /* Asegurar que el content-wrapper use bien el espacio vertical */
  .content-wrapper {
    gap: 20px !important;           /* Más espacio entre complex2 y complex3 */
    padding: 0 10px !important;
  }

  /* Ajuste fino: que el media-container ocupe más altura sin romper layout */
  .complex2 {
    flex: 0 0 auto !important;     /* No crecer innecesariamente */
  }

  /* Opcional: si quieres que el cuadrado sea aún más grande, limita max-height */
  /* .media-container { max-height: 65vh !important; } */
}  
@media (max-width: 768px) {
  /* Reproductor minimizado: unión perfecta con barra inferior */
  #playerMinimized {
    position: fixed !important;
    bottom: calc(60px + env(safe-area-inset-bottom)) !important; /* Fallback estático; JS lo ajusta dinámicamente */
    left: 0 !important;
    right: 0 !important;
    width: 100% !important;
    z-index: 1001 !important; /* Encima de barra (1000) */
    background: #222 !important;
    border-top-left-radius: 12px !important;
    border-top-right-radius: 12px !important;
    border-bottom-left-radius: 0 !important; /* Plano en bottom para unión */
    border-bottom-right-radius: 0 !important;
    box-shadow: none !important; /* Removida la sombra para no separar visualmente */
    /* Si quieres una sombra sutil hacia arriba (no down), agrega: box-shadow: 0 -1px 4px rgba(0,0,0,0.2) !important; */
  }
  
  
  </style>
</head>
<body>
 <div id="playerUniversal" class="player-universal">
    <div id="playerExpanded" class="player-expanded" style="display: none;">
      <div class="complex1 top-controls">
        <button id="mediaModeToggle" class="media-mode-toggle">
  <span class="mode-left">Audio</span>
  <span class="mode-right">Video</span>
</button>
        <button id="minimizeBtn" class="minimize-btn">
          <img src="https://marca1.odoo.com/web/image/490-b15e1d52/minimizar.svg" alt="Minimize" loading="lazy">
        </button>
      </div>
      <div class="content-wrapper">
        <div class="complex2">
          <div id="mediaContainer" class="media-container">
            <video id="mediaElement" style="display: none;" controlsList="nodownload nofullscreen noremoteplayback" disablePictureInPicture preload="metadata"></video>
            <img id="mediaCover" style="display: block;" src="" loading="lazy">
            <div class="overlay-gradient" id="overlayGradient">
              <div class="media-controls-center">
                <button id="playPauseMedia" class="control-btn">
                  <img id="playPauseIconMedia" src="https://nikichitonjesus.odoo.com/web/image/1140-f876320c/play.svg" alt="Play" loading="lazy">
                </button>
              </div>
              <div class="media-controls-bottom">
                <button id="volumeBtn" class="volume-btn">
                  <img id="volumeIcon" src="https://marca1.odoo.com/web/image/505-b00aeb8e/volumen.svg" alt="Volume" loading="lazy">
                </button>
                <button id="fullscreenBtn" class="fullscreen-btn">
                  <img src="https://marca1.odoo.com/web/image/499-48202209/full.svg" alt="Fullscreen" loading="lazy">
                </button>
              </div>
            </div>
            <div class="seek-indicator-left" id="seekIndicatorLeft">
              <span id="seekSecondsLeft">15s</span>
              <img src="https://marca1.odoo.com/web/image/506-1607e7a0/retroceder%2015.svg" alt="Rewind" loading="lazy">
            </div>
            <div class="seek-indicator-right" id="seekIndicatorRight">
              <img src="https://marca1.odoo.com/web/image/504-db1a8f7a/avanzar%2015s.svg" alt="Forward" loading="lazy">
              <span id="seekSecondsRight">15s</span>
            </div>
            <div id="fullscreenControls" class="fullscreen-controls" style="display: none;">
              <div class="fullscreen-title" id="fullscreenTitle"></div>
              <div class="fullscreen-center-controls">
                <button id="previousFullscreen" class="control-btn">
                  <img src="https://nikichitonjesus.odoo.com/web/image/1072-2fba0e95/ant.webp" alt="Previous" loading="lazy">
                </button>
                <button id="rewindFullscreen" class="control-btn">
                  <img src="https://marca1.odoo.com/web/image/503-ed98d111/retroceder15.svg" alt="Rewind" loading="lazy">
                </button>
                <button id="playPauseFullscreen" class="control-btn">
                  <img id="playPauseIconFullscreen" src="https://nikichitonjesus.odoo.com/web/image/1140-f876320c/play.svg" alt="Play" loading="lazy">
                </button>
                <button id="forwardFullscreen" class="control-btn">
                  <img src="https://marca1.odoo.com/web/image/507-089c3773/avanzar15.svg" alt="Forward" loading="lazy">
                </button>
                <button id="nextFullscreen" class="control-btn">
                  <img src="https://nikichitonjesus.odoo.com/web/image/1068-bc302591/sig.webp" alt="Next" loading="lazy">
                </button>
              </div>
              <div class="fullscreen-bottom-bar">
                <span id="currentTimeFullscreen">00:00</span>
                <div class="video-progress-container-fullscreen" id="progressContainerFullscreen">
                  <div class="progress-bar-fullscreen" id="progressBarFullscreen"></div>
                </div>
                <span id="durationFullscreen">00:00</span>
                <button id="volumeFullscreen" class="volume-btn">
                  <img id="volumeIconFullscreen" src="https://marca1.odoo.com/web/image/505-b00aeb8e/volumen.svg" alt="Volume" loading="lazy">
                </button>
                <button id="exitFullscreenBtn" class="fullscreen-btn">
                  <img src="https://marca1.odoo.com/web/image/501-7b0e44ac/Exitfull.svg" alt="Exit Fullscreen" loading="lazy">
                </button>
              </div>
            </div>
            <div id="muteIndicator" class="mute-indicator" style="display: none;">Silenciado</div>
          </div>
        </div>
        <div class="complex3">
          <div class="episode-info" id="episodeInfo">
            <div class="left-section">
              <img src="" alt="Portada" loading="lazy">
            </div>
            <div class="center-section">
              <span id="episodeTitle"></span>
              <span class="author" id="episodeAuthor"></span>
            </div>
            <div class="right-section">
              <button id="addToPlaylistBtn">
                <img id="addToPlaylistIcon" src="https://nikichitonjesus.odoo.com/web/image/772-ea85aa4b/a%C3%B1adir%20a.png" alt="Add to Playlist" loading="lazy">
              </button>
            </div>
          </div>
          <div class="video-progress-container-expanded" id="progressContainerExpanded">
            <div class="progress-bar-expanded" id="progressBarExpanded">
              <div class="progress-knob-expanded"></div>
            </div>
          </div>
          <div class="time-info">
            <span id="currentTimeExpanded">00:00</span>
            <span id="durationExpanded">00:00</span>
          </div>
          <div class="controls">
            <div class="speed-container">
              <img id="speedIcon" src="https://nikichitonjesus.odoo.com/web/image/1113-9a93ad3a/speed.png" alt="Velocidad" loading="lazy">
            </div>
            <button id="previousExpanded">
              <img src="https://marca1.odoo.com/web/image/502-e1f7bc1b/ant.svg" alt="Previous" loading="lazy">
            </button>
            <button id="rewindExpanded">
              <img src="https://marca1.odoo.com/web/image/503-ed98d111/retroceder15.svg" alt="Rewind" loading="lazy">
            </button>
            <button id="playPauseExpanded">
              <img id="playPauseIconExpanded" src="https://nikichitonjesus.odoo.com/web/image/984-ba35a699/play.webp" alt="Play" loading="lazy">
            </button>
            <button id="forwardExpanded">
              <img src="https://marca1.odoo.com/web/image/507-089c3773/avanzar15.svg" alt="Forward" loading="lazy">
            </button>
            <button id="nextExpanded">
              <img src="https://marca1.odoo.com/web/image/500-1957f422/sig.svg" alt="Next" loading="lazy">
            </button>
            <div class="timer-container">
              <img id="timerIcon" src="https://marca1.odoo.com/web/image/512-4489ad50/tempo.svg" alt="Timer" loading="lazy">
            </div>
          </div>
          <div class="action-buttons-container">
            <div class="action-buttons" id="actionButtons">
              <button id="likesBtn" class="action-btn">
                <img id="likesIcon" src="https://marca1.odoo.com/web/image/511-0363beb5/meg.svg" alt="Me gusta" loading="lazy">
                <span>Me gusta</span>
              </button>
              <button id="downloadBtn" class="action-btn">
                <img id="downloadIcon" src="https://nikichitonjesus.odoo.com/web/image/624-ec376d7f/descargar.png" alt="Download" loading="lazy">
                <span>Descargar</span>
              </button>
              <button id="shareBtn" class="action-btn">
                <img src="https://nikichitonjesus.odoo.com/web/image/585-036b7961/cpmartir.png" alt="Share" loading="lazy">
                <span>Compartir</span>
              </button>
              <button id="repeatBtn" class="action-btn">
                <img src="https://nikichitonjesus.odoo.com/web/image/771-e8de83ec/repetir-.png" alt="Repeat" loading="lazy">
                <span>Repetir</span>
              </button>
              <button id="colaBtn" class="action-btn">
                <img src="https://marca1.odoo.com/web/image/515-2e6082a5/cola.svg" alt="Cola" loading="lazy">
                <span>Cola</span>
              </button>
              <button id="detallesBtn" class="action-btn">
                <img src="https://nikichitonjesus.odoo.com/web/image/995-7301139c/trasncrip.webp" alt="Detalles" loading="lazy">
                <span>Detalles</span>
              </button>
              <button id="bibliotecaBtn" class="action-btn">
                <img src="https://marca1.odoo.com/web/image/517-7bde9b69/Archive.svg" alt="Biblioteca" loading="lazy">
                <span>Biblioteca</span>
              </button>
            </div>
          </div>
          <div class="program-container">
            <button id="programBtn" class="full-width-btn">
              <img src="https://www.nikichitonjesus.org/web/image/568-7e4a907b/Hoy.webp" alt="Program" loading="lazy">
              <span>Programa del Día</span>
            </button>
          </div>
          <div class="tabs-text">
            <a id="linkCola"><b><span style="color: white;">A continuación</span></b></a>
            <a id="linkDetalles"><b><span style="color: white;">Detalles</span></b></a>
            <a id="linkBiblioteca"><b><span style="color: white;">Biblioteca</span></b></a>
          </div>
        </div>
      </div>
      <div class="panel-container" id="panelContainer" style="display: none;">
        <div class="panel-header">
  <div class="tabs">
    <a id="tabCola" class="tab-content active">Cola</a>
    <a id="tabDetalles" class="tab-content">Detalles</a>
    <a id="tabBiblioteca" class="tab-content">Biblioteca</a>
    <a id="tabVelocidad" class="tab-speed">Velocidad</a>
    <a id="tabTemporizador" class="tab-timer">Temporizador</a>
  </div>
  <div class="panel-controls">
    <button id="togglePanelHeightBtn">
      <img src="https://marca1.odoo.com/web/image/513-e0bcd17f/maz.svg" alt="Ampliar/Minimizar" loading="lazy">
    </button>
    <button id="closePanelBtn">
      <img src="https://marca1.odoo.com/web/image/518-a62b303e/cierra.svg" alt="Cerrar" loading="lazy">
    </button>
  </div>
</div>
        <div class="panel-content">
          <div id="colaContent" class="panel-section active">
            <div class="next-items" id="nextItems"></div>
            <div class="separator" id="recomendadosSeparator" style="display: none;">
              <hr>
              <h4>Recomendados</h4>
            </div>
            <div class="recomendados-items" id="recomendadosItems"></div>
          </div>
          <div id="detallesContent" class="panel-section">
            <div class="text-content" id="textContent"></div>
          </div>
          <div id="bibliotecaContent" class="panel-section">
            <div class="likes-section">
              <h4>Tus me gusta</h4>
              <button id="viewAllLikes">Ver todo</button>
              <div id="likesView" class="likes-view carousel">
                <div class="likes-carousel" id="likesCarousel"></div>
              </div>
            </div>
            <div class="playlist-section">
              <h4>Tu lista</h4>
              <div class="playlist-items" id="playlistItems"></div>
              <button id="playUserPlaylistBtn">Reproducir esta lista</button>
            </div>
          </div>
          <div id="velocidadContent" class="panel-section">
            <div class="options-panel">
              <span id="currentSpeed">1x</span>
              <input type="range" id="speedSlider" min="0.25" max="2" step="0.25" value="1">
              <div class="speed-labels">
                <span>0.25x</span><span>0.5x</span><span>0.75x</span><span>1x</span><span>1.25x</span><span>1.5x</span><span>1.75x</span><span>2x</span>
              </div>
            </div>
          </div>
          <div id="temporizadorContent" class="panel-section">
  <div id="timerCountdown" style="display: none;">
    <span id="countdownDisplay"></span>
    <button id="deactivateTimer">Desactivar temporizador</button>
  </div>
  <div id="timerOptions" class="options-panel timer-options">
    <button data-value="5">5 min</button>
    <button data-value="10">10 min</button>
    <button data-value="15">15 min</button>
    <button data-value="30">30 min</button>
    <button data-value="45">45 min</button>
    <button data-value="60">1 hora</button>
    <button data-value="end">Fin del episodio</button>
  </div>
</div>
        </div>
      </div>
    </div>
    <div id="playerMinimized" class="player-minimized">
      <div class="video-progress-container-minimized" id="progressContainerMinimized">
        <div class="progress-bar-minimized" id="progressBarMinimized">
          <div class="progress-knob-minimized"></div>
        </div>
      </div>
      <div class="minimized-content">
        <div class="minimized-cover">
          <img id="minimizedCover" src="" alt="Portada" loading="lazy">
        </div>
        <div class="minimized-title-container">
          <span id="episodeTitleMinimized" class="minimized-title"></span>
        </div>
        <div class="minimized-controls">
          <button id="rewindMinimized">
            <img src="https://marca1.odoo.com/web/image/503-ed98d111/retroceder15.svg" alt="Rewind" loading="lazy">
          </button>
          <button id="playPauseMinimized">
            <img id="playPauseIconMinimized" src="https://marca1.odoo.com/web/image/508-f876320c/play.svg" alt="Play" loading="lazy">
          </button>
          <button id="forwardMinimized">
            <img src="https://marca1.odoo.com/web/image/507-089c3773/avanzar15.svg" alt="Fast Forward" loading="lazy">
          </button>
          <button id="expandBtn">
            <img src="https://marca1.odoo.com/web/image/516-3ecd56b1/full-2.svg" alt="Expand" loading="lazy">
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
let specialPlayer = null;
let playlist = JSON.parse(localStorage.getItem('playlist')) || [];
let likes = JSON.parse(localStorage.getItem('likes')) || [];
let historyList = JSON.parse(localStorage.getItem('history')) || [];
let currentIndex = -1;
let nextList = [];
let recomendados = window.RECOMENDADOS || [];
let cachedRecomendados = []; // NUEVO: Cache para preservar orden aleatorio de recomendados
let episodeText = '';
let episodeAuthor = 'Roberto';
let activeList = 'next';
let userPlaylistAutoPlay = false;
let timerValue = 0;
let timerId = null;
let timerCountdownInterval = null;
let tapCount = 0;
let tapSide = '';
let lastTapTime = 0;
let tapTimeout = null;
let isAudioMode = true;
let isFullscreenMode = false;
let repeatMode = 0;
let currentEpisodeId = null;
let showControls = false;
let isAutoMuted = false;
let isUserMuted = false;
let likesViewMode = 'carousel';
const playerUniversal = document.getElementById('playerUniversal');
const playerExpanded = document.getElementById('playerExpanded');
const playerMinimized = document.getElementById('playerMinimized');
let mediaElement = document.getElementById('mediaElement');
const mediaCover = document.getElementById('mediaCover');
const mediaContainer = document.getElementById('mediaContainer');
const minimizeBtn = document.getElementById('minimizeBtn');
const mediaModeToggle = document.getElementById('mediaModeToggle');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const volumeBtn = document.getElementById('volumeBtn');
const volumeIcon = document.getElementById('volumeIcon');
const expandBtn = document.getElementById('expandBtn');
const episodeInfo = document.getElementById('episodeInfo');
const episodeTitle = document.getElementById('episodeTitle');
const episodeTitleMinimized = document.getElementById('episodeTitleMinimized');
const episodeAuthorElem = document.getElementById('episodeAuthor');
const minimizedCover = document.getElementById('minimizedCover');
const progressContainerExpanded = document.getElementById('progressContainerExpanded');
const progressBarExpanded = document.getElementById('progressBarExpanded');
const progressContainerMinimized = document.getElementById('progressContainerMinimized');
const progressBarMinimized = document.getElementById('progressBarMinimized');
const currentTimeExpanded = document.getElementById('currentTimeExpanded');
const durationExpanded = document.getElementById('durationExpanded');
const playPauseExpanded = document.getElementById('playPauseExpanded');
const playPauseIconExpanded = document.getElementById('playPauseIconExpanded');
const playPauseMinimized = document.getElementById('playPauseMinimized');
const playPauseIconMinimized = document.getElementById('playPauseIconMinimized');
const rewindExpanded = document.getElementById('rewindExpanded');
const forwardExpanded = document.getElementById('forwardExpanded');
const previousExpanded = document.getElementById('previousExpanded');
const nextExpanded = document.getElementById('nextExpanded');
const rewindMinimized = document.getElementById('rewindMinimized');
const forwardMinimized = document.getElementById('forwardMinimized');
const speedIcon = document.getElementById('speedIcon');
const speedSlider = document.getElementById('speedSlider');
const currentSpeed = document.getElementById('currentSpeed');
const timerIcon = document.getElementById('timerIcon');
const timerOptions = document.getElementById('timerOptions');
const timerCountdown = document.getElementById('timerCountdown');
const countdownDisplay = document.getElementById('countdownDisplay');
const deactivateTimer = document.getElementById('deactivateTimer');
const downloadBtn = document.getElementById('downloadBtn');
const downloadIcon = document.getElementById('downloadIcon');
const shareBtn = document.getElementById('shareBtn');
const programBtn = document.getElementById('programBtn');
const repeatBtn = document.getElementById('repeatBtn');
const addToPlaylistBtn = document.getElementById('addToPlaylistBtn');
const addToPlaylistIcon = document.getElementById('addToPlaylistIcon');
const colaBtn = document.getElementById('colaBtn');
const detallesBtn = document.getElementById('detallesBtn');
const bibliotecaBtn = document.getElementById('bibliotecaBtn');
const likesBtn = document.getElementById('likesBtn');
const likesIcon = document.getElementById('likesIcon');
const panelContainer = document.getElementById('panelContainer');
const likesCarousel = document.getElementById('likesCarousel');
const playlistItems = document.getElementById('playlistItems');
const closePanelBtn = document.getElementById('closePanelBtn');
const togglePanelHeightBtn = document.getElementById('togglePanelHeightBtn');
const nextItems = document.getElementById('nextItems');
const recomendadosItems = document.getElementById('recomendadosItems');
const recomendadosSeparator = document.getElementById('recomendadosSeparator');
const textContent = document.getElementById('textContent');
const tabCola = document.getElementById('tabCola');
const tabDetalles = document.getElementById('tabDetalles');
const tabBiblioteca = document.getElementById('tabBiblioteca');
const tabVelocidad = document.getElementById('tabVelocidad');
const tabTemporizador = document.getElementById('tabTemporizador');
const colaContent = document.getElementById('colaContent');
const detallesContent = document.getElementById('detallesContent');
const bibliotecaContent = document.getElementById('bibliotecaContent');
const velocidadContent = document.getElementById('velocidadContent');
const temporizadorContent = document.getElementById('temporizadorContent');
const linkCola = document.getElementById('linkCola');
const linkDetalles = document.getElementById('linkDetalles');
const linkBiblioteca = document.getElementById('linkBiblioteca');
const speedContainer = document.querySelector('.speed-container');
const timerContainer = document.querySelector('.timer-container');
const overlayGradient = document.getElementById('overlayGradient');
const playPauseMedia = document.getElementById('playPauseMedia');
const playPauseIconMedia = document.getElementById('playPauseIconMedia');
const seekIndicatorLeft = document.getElementById('seekIndicatorLeft');
const seekSecondsLeft = document.getElementById('seekSecondsLeft');
const seekIndicatorRight = document.getElementById('seekIndicatorRight');
const seekSecondsRight = document.getElementById('seekSecondsRight');
const fullscreenControls = document.getElementById('fullscreenControls');
const fullscreenTitle = document.getElementById('fullscreenTitle');
const progressContainerFullscreen = document.getElementById('progressContainerFullscreen');
const progressBarFullscreen = document.getElementById('progressBarFullscreen');
const progressKnobFullscreen = progressBarFullscreen.appendChild(document.createElement('div'));
progressKnobFullscreen.className = 'progress-knob-fullscreen';
const currentTimeFullscreen = document.getElementById('currentTimeFullscreen');
const durationFullscreen = document.getElementById('durationFullscreen');
const playPauseFullscreen = document.getElementById('playPauseFullscreen');
const playPauseIconFullscreen = document.getElementById('playPauseIconFullscreen');
const rewindFullscreen = document.getElementById('rewindFullscreen');
const forwardFullscreen = document.getElementById('forwardFullscreen');
const previousFullscreen = document.getElementById('previousFullscreen');
const nextFullscreen = document.getElementById('nextFullscreen');
const volumeFullscreen = document.getElementById('volumeFullscreen');
const volumeIconFullscreen = document.getElementById('volumeIconFullscreen');
const exitFullscreenBtn = document.getElementById('exitFullscreenBtn');
const muteIndicator = document.getElementById('muteIndicator');
const viewAllLikes = document.getElementById('viewAllLikes');
const likesView = document.getElementById('likesView');
let currentMedia = null;
let isExpanded = false;
let isHidden = false;
let isLooping = false;
let isMuted = false;
let isDraggingExpanded = false;
let isDraggingMinimized = false;
let isDraggingFullscreen = false;
let touchStartY = 0;
let touchEndY = 0;
let swipeThreshold = 100;
let isSwiping = false;
let isPanelFullHeight = false;
const groups = {
  content: ['cola', 'detalles', 'biblioteca'],
  speed: ['velocidad'],
  timer: ['temporizador']
};
const getGroup = (tab) => {
  for (let g in groups) {
    if (groups[g].includes(tab)) return g;
  }
  return 'content';
};
const updateVisibleTabs = (group) => {
  document.querySelectorAll('.tabs a').forEach(t => {
    t.classList.remove('visible');
    const tabName = t.id.replace('tab', '').toLowerCase();
    if (groups[group].includes(tabName)) {
      t.classList.add('visible');
    }
  });
};
const saveState = () => {
  const state = {
    mediaUrl: currentMedia?.mediaUrl,
    mediaType: currentMedia?.mediaType,
    coverUrlContainer: currentMedia?.coverUrlContainer,
    coverUrlInfo: currentMedia?.coverUrlInfo,
    title: currentMedia?.title,
    detailUrl: currentMedia?.detailUrl,
    author: currentMedia?.author,
    next: currentMedia?.next,
    text: currentMedia?.text,
    allowDownload: currentMedia?.allowDownload,
    currentTime: mediaElement.currentTime,
    isPlaying: !mediaElement.paused,
    playbackRate: mediaElement.playbackRate,
    isExpanded: isExpanded,
    isHidden: isHidden,
    isLooping: isLooping,
    isMuted: mediaElement.muted,
    isAudioMode: isAudioMode,
    activeList: activeList,
    userPlaylistAutoPlay: userPlaylistAutoPlay,
    timerValue: timerValue,
    repeatMode: repeatMode,
  };
  localStorage.setItem('playerState', JSON.stringify(state));
  localStorage.setItem('playlist', JSON.stringify(playlist));
  localStorage.setItem('likes', JSON.stringify(likes));
  localStorage.setItem('history', JSON.stringify(historyList));
};
const throttle = (func, limit) => {
  let lastCall = null;
  return (...args) => {
    const now = Date.now();
    if (!lastCall || now - lastCall > limit) {
      lastCall = now;
      return func(...args);
    }
  };
};
const throttledSaveState = throttle(saveState, 500);
const loadImageWithFallback = (imgElement, src, alt, fallbackSrc) => {
  imgElement.src = src;
  imgElement.alt = alt;
  imgElement.onerror = () => {
    imgElement.src = fallbackSrc || 'https://via.placeholder.com/24';
    imgElement.onerror = null;
  };
};
const cleanEvents = () => {
  mediaElement.removeEventListener('timeupdate', updateProgress);
  mediaElement.removeEventListener('loadedmetadata', updateProgress);
  mediaElement.removeEventListener('volumechange', checkMute);
  mediaElement.removeEventListener('ended', handleMediaEnd);
  const newMediaElement = mediaElement.cloneNode(true);
  mediaElement.parentNode.replaceChild(newMediaElement, mediaElement);
  mediaElement = newMediaElement;
  mediaElement.addEventListener('timeupdate', updateProgress);
  mediaElement.addEventListener('loadedmetadata', updateProgress);
  mediaElement.addEventListener('volumechange', checkMute);
  mediaElement.addEventListener('ended', handleMediaEnd);
};

// NUEVA HELPER: Mapea un episodio de RECOMENDADOS a los params de loadMedia
const mapEpisodeToMedia = (item) => {
  return {
    mediaUrl: item.mediaUrl || '',
    mediaType: item.type || 'audio',
    coverUrlContainer: item.coverUrl || '',
    coverUrlInfo: item.series?.portada_serie || item.coverUrl || '',
    title: item.title || '',
    detailUrl: item.detailUrl || '',
    author: item.series?.titulo_serie || 'Unknown',
    next: [],
    text: item.description || '',
    allowDownload: true  // Default para recomendados
  };
};

const loadState = () => {
  const state = JSON.parse(localStorage.getItem('playerState')) || {};
  if (state.mediaUrl) {
    loadMedia(
      state.mediaUrl,
      state.mediaType,
      state.coverUrlContainer,
      state.coverUrlInfo,
      state.title,
      state.detailUrl,
      state.author || 'Roberto',
      state.next || [],
      state.text || '',
      state.allowDownload || true
    );
    mediaElement.addEventListener('canplay', () => {
      mediaElement.currentTime = state.currentTime || 0;
      mediaElement.playbackRate = state.playbackRate || 1;
      mediaElement.muted = state.isMuted || false;
      isAudioMode = state.isAudioMode || true;
      updateMediaMode();
      if (state.isPlaying) {
        playWithFallback();
        updateIcons(true);
      } else {
        mediaElement.pause();
        updateIcons(false);
      }
    }, { once: true });
    updateSpeedButtons(state.playbackRate || 1);
    repeatMode = state.repeatMode || 0;
    updateRepeatButton();
    activeList = state.activeList || 'next';
    userPlaylistAutoPlay = state.userPlaylistAutoPlay || false;
    timerValue = state.timerValue || 0;
    if (timerValue !== 0) {
      setupTimer();
    }
    showMinimized();
    updatePlaylist();
    updateLikes();
    updateModeToggleState();
    // NUEVO: Recache recomendados al cargar estado
    cachedRecomendados = [...window.RECOMENDADOS];
  } else {
    const programa = window.PROGRAMA_DEL_DIA || {
      mediaUrl: 'https://awscdn.podcasts.com/audio-vhhlggMJNysHnLYW8KXAQwu4w.mp3',
      mediaType: 'audio',
      coverUrlContainer: 'https://s3.amazonaws.com/podcasts-image-uploads/el-populismo-y-la-democracia-jesus-huerta-de-soto-1400x1400.png',
      coverUrlInfo: 'https://www.edu.balta.lat/web/image/415-8ae27244/media.png',
      title: 'El populismo y la democracia',
      detailUrl: '#',
      author: "Jesús Huerta de Soto",
      text: "No disponible",
      allowDownload: true
    };
    loadMedia(programa.mediaUrl, programa.mediaType, programa.coverUrlContainer, programa.coverUrlInfo, programa.title, programa.detailUrl, programa.author, [], programa.text, programa.allowDownload);
    showMinimized();
    cachedRecomendados = [...window.RECOMENDADOS];
  }
  updateMediaSession(); // Fuerza inicial al restaurar estado
};
const playWithFallback = () => {
  mediaElement.muted = isMuted;
  mediaElement.play().then(() => {
    updateIcons(true);
    updateAllItemIcons(true);
    isAutoMuted = false;
    updateMediaSession(); // Fuerza actualización al iniciar play real
  }).catch((error) => {
    console.log("Autoplay blocked, trying muted:", error);
    mediaElement.muted = true;
    isMuted = true;
    isAutoMuted = true;
    isUserMuted = false;
    mediaElement.play().then(() => {
      updateIcons(true);
      updateAllItemIcons(true);
      showMuteIndicator();
      updateMediaSession(); // También en fallback
    }).catch((err) => {
      console.log("Play failed:", err);
    });
  });
};
const showMuteIndicator = () => {
  if (isAutoMuted && !isUserMuted) {
    muteIndicator.style.display = 'block';
  } else {
    muteIndicator.style.display = 'none';
  }
};
 
const updateMediaMode = () => {
  mediaModeToggle.classList.toggle('audio', isAudioMode);
  mediaModeToggle.classList.toggle('video', !isAudioMode);
  if (isAudioMode) {
    mediaElement.style.display = 'none';
    mediaCover.style.display = 'block';
    mediaModeToggle.querySelector('.mode-right').classList.add('disabled');
  } else {
    if (currentMedia.mediaType === 'video') {
      mediaElement.style.display = 'block';
      mediaCover.style.display = 'none';
      mediaModeToggle.querySelector('.mode-right').classList.remove('disabled');
    } else {
      mediaElement.style.display = 'none';
      mediaCover.style.display = 'block';
      mediaModeToggle.querySelector('.mode-right').classList.add('disabled');
    }
  }
};
const toggleMediaMode = () => {
  if (currentMedia.mediaType === 'video') {
    isAudioMode = !isAudioMode;
    updateMediaMode();
    updateModeToggleState();
    throttledSaveState();
  }
};
 
  // Función para actualizar el estado visual del toggle Audio/Video
const updateModeToggleState = () => {
  const toggle = document.getElementById('mediaModeToggle');
  if (!toggle) return; // Seguridad si el elemento no existe aún
  const left = toggle.querySelector('.mode-left');
  const right = toggle.querySelector('.mode-right');
  // Resetear todas las clases relevantes
  toggle.classList.remove('disabled', 'audio', 'video', 'active-left', 'active-right');
  left.classList.remove('active');
  right.classList.remove('active');
  // Caso 1: No hay video disponible (solo audio)
  if (!currentMedia || currentMedia.mediaType !== 'video') {
    toggle.classList.add('disabled');
    toggle.classList.add('audio'); // Muestra como audio activo
    left.classList.add('active');
  }
  // Caso 2: Hay video → se puede alternar
  else {
    toggle.classList.remove('disabled');
    if (isAudioMode) {
      toggle.classList.add('audio', 'active-left');
      left.classList.add('active');
    } else {
      toggle.classList.add('video', 'active-right');
      right.classList.add('active');
    }
  }
};

// CORREGIDA: loadMedia - Maneja cola vacía -> recomendados, y click en recomendado
const loadMedia = (mediaUrl, mediaType, coverUrlContainer, coverUrlInfo, title, detailUrl, author = 'Roberto', next = [], text = '', allowDownload = true, isFromRecomendados = false, recIndex = -1) => {
  try {
    currentEpisodeId = mediaUrl;
    if (timerId && timerValue === 'end') {
      clearTimeout(timerId);
      timerId = null;
      updateTimerButtons(0);
      timerContainer.classList.remove('active');
    }
    cleanEvents();
    currentMedia = { mediaUrl, mediaType, coverUrlContainer, coverUrlInfo, title, detailUrl, author, next, text, allowDownload };
    mediaElement.src = mediaUrl;
    mediaElement.load();
    loadImageWithFallback(
      mediaCover,
      coverUrlContainer || 'https://niki-chiton-jesus.odoo.com/web/image/slide.channel/1/image_1024/Cuando%20comenz%C3%B3%20todo?unique=6ba13cc',
      'Cover',
      'https://via.placeholder.com/300'
    );
    episodeTitle.textContent = title || '';
    episodeTitle.setAttribute('data-text', title || '');
    episodeTitleMinimized.textContent = title || '';
    episodeTitleMinimized.setAttribute('data-text', title || '');
    fullscreenTitle.textContent = title || '';
    episodeAuthorElem.textContent = author;
    loadImageWithFallback(
      episodeInfo.querySelector('.left-section img'),
      coverUrlInfo || 'https://i.pinimg.com/280x280_RS/2a/ec/33/2aec332af056fc746a0a3552a6f97fc5.jpg',
      'Portada',
      'https://via.placeholder.com/40'
    );
    loadImageWithFallback(
      minimizedCover,
      coverUrlInfo || 'https://i.pinimg.com/280x280_RS/2a/ec/33/2aec332af056fc746a0a3552a6f97fc5.jpg',
      'Portada',
      'https://via.placeholder.com/40'
    );
    playerUniversal.style.display = 'block';
    nextList = next;
    episodeText = text;
    currentIndex = nextList.findIndex(item => item.mediaUrl === mediaUrl);
    if (currentIndex === -1) currentIndex = 0;

    // NUEVO: Lógica para autoplay con recomendados
    if (next.length === 0) { // Episodio único
      if (isFromRecomendados && recIndex >= 0) {
        // Click en recomendado: Continúa con el resto en orden
        nextList = cachedRecomendados.slice(recIndex + 1).map(mapEpisodeToMedia);
        activeList = 'next';
      } else {
        // Cualquier único: Copia toda la lista de recomendados como cola
        nextList = cachedRecomendados.map(mapEpisodeToMedia);
        activeList = 'next';
      }
    }

    updateNextList();
    updateRecomendadosList();
    updateTextContent();
    updateAddButton();
    updateDownloadButton();
    updateLikesButton();
    const playEvent = new CustomEvent('universalVideoPlay', { detail: { playerId: 'universal-player' } });
    window.dispatchEvent(playEvent);
    updatePlaylist();
    updateLikes();
    checkTitleOverflow();
    checkMinimizedTitleOverflow();
    if (!historyList.some(item => item.mediaUrl === mediaUrl)) {
      historyList.push(currentMedia);
      throttledSaveState();
    }
    isAudioMode = mediaType !== 'video';
    updateMediaMode();
    updateModeToggleState();
    updateMediaSession(); // Fuerza actualización al cargar
  } catch (error) {
    console.error('Error loading media:', error);
  }
};
 
 
const updateDownloadButton = () => {
  if (currentMedia.allowDownload) {
    downloadBtn.classList.remove('disabled');
    loadImageWithFallback(downloadIcon, 'https://nikichitonjesus.odoo.com/web/image/624-ec376d7f/descargar.png', 'Download', 'https://via.placeholder.com/20');
  } else {
    downloadBtn.classList.add('disabled');
    loadImageWithFallback(downloadIcon, 'https://nikichitonjesus.odoo.com/web/image/1051-622a3db3/no-desc.webp', 'Download Disabled', 'https://via.placeholder.com/20');
  }
};
const updateAddButton = () => {
  if (playlist.some(item => item.mediaUrl === currentMedia?.mediaUrl)) {
    loadImageWithFallback(addToPlaylistIcon, 'https://nikichitonjesus.odoo.com/web/image/1112-d141b3eb/a%C3%B1adido.png', 'Added', 'https://via.placeholder.com/20');
  } else {
    loadImageWithFallback(addToPlaylistIcon, 'https://nikichitonjesus.odoo.com/web/image/772-ea85aa4b/a%C3%B1adir%20a.png', 'Add to Playlist', 'https://via.placeholder.com/20');
  }
};
const updateLikesButton = () => {
  if (likes.some(item => item.mediaUrl === currentMedia?.mediaUrl)) {
    loadImageWithFallback(likesIcon, 'https://nikichitonjesus.odoo.com/web/image/1069-2ad205f2/megus.webp', 'Liked', 'https://via.placeholder.com/20');
    likesBtn.querySelector('span').textContent = 'Te gusta';
  } else {
    loadImageWithFallback(likesIcon, 'https://marca1.odoo.com/web/image/511-0363beb5/meg.svg', 'Me gusta', 'https://via.placeholder.com/20');
    likesBtn.querySelector('span').textContent = 'Me gusta';
  }
};
const toggleLikes = () => {
  if (!currentMedia) return;
  const index = likes.findIndex(item => item.mediaUrl === currentMedia.mediaUrl);
  if (index > -1) {
    likes.splice(index, 1);
  } else {
    likes.unshift({ ...currentMedia, addedDate: Date.now() });
  }
  localStorage.setItem('likes', JSON.stringify(likes));
  updateLikes();
  updateLikesButton();
  throttledSaveState();
};
const updateLikes = () => {
  likesCarousel.innerHTML = '';
  likes.sort((a, b) => b.addedDate - a.addedDate);
  likesView.className = 'likes-view ' + likesViewMode;
  if (likes.length > 0) {
    likes.forEach((item) => {
      const div = document.createElement('div');
      div.className = 'likes-item';
      div.innerHTML = `
        <img src="${item.coverUrlInfo || 'https://via.placeholder.com/80'}" alt="Cover" loading="lazy">
        <span>${item.title}</span>
      `;
      div.addEventListener('click', (e) => {
        e.stopPropagation();
        loadMedia(item.mediaUrl, item.mediaType, item.coverUrlContainer, item.coverUrlInfo, item.title, item.detailUrl, item.author, item.next, item.text, item.allowDownload);
        togglePlayPause(true);
        throttledSaveState();
      });
      likesCarousel.appendChild(div);
    });
  } else {
    likesCarousel.innerHTML = '<div class="no-items">No hay me gusta</div>';
  }
};
const toggleLikesView = () => {
  likesViewMode = likesViewMode === 'carousel' ? 'grid' : 'carousel';
  updateLikes();
  viewAllLikes.textContent = likesViewMode === 'grid' ? 'Ver carrusel' : 'Ver todo';
};
const updatePlaylist = () => {
  playlistItems.innerHTML = '';
  if (playlist.length > 0) {
    playlist.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'playlist-item';
      div.draggable = true;
      div.dataset.index = index;
      if (item.mediaUrl === currentMedia?.mediaUrl) {
        div.classList.add('active');
      }
      div.innerHTML = `
        <img class="cover" src="${item.coverUrlInfo || 'https://via.placeholder.com/30'}" alt="Cover" loading="lazy">
        <span>${item.title}</span>
        <div class="item-controls">
          <button class="item-play-pause">
            <img src="${(item.mediaUrl === currentMedia?.mediaUrl) ? (mediaElement.paused ? 'https://marca1.odoo.com/web/image/508-f876320c/play.svg' : 'https://nikichitonjesus.odoo.com/web/image/983-5c0bffd9/Pause.webp') : 'https://marca1.odoo.com/web/image/508-f876320c/play.svg'}" alt="Play/Pause" loading="lazy">
          </button>
          <button class="remove-playlist-item" data-index="${index}">
            <img src="https://niki-chiton-jesus.odoo.com/web/image/457-5d13d269/remove.webp" alt="Remove" loading="lazy">
          </button>
          <div class="drag-handle">
            <img src="https://nikichitonjesus.odoo.com/web/image/813-b2644056/listbtn.webp" alt="Drag" loading="lazy">
          </div>
        </div>
      `;
      div.addEventListener('click', (e) => {
        if (!e.target.closest('.remove-playlist-item') && !e.target.closest('.drag-handle') && !e.target.closest('.item-play-pause')) {
          e.stopPropagation();
          currentIndex = index;
          loadMedia(item.mediaUrl, item.mediaType, item.coverUrlContainer, item.coverUrlInfo, item.title, item.detailUrl, item.author, item.next, item.text, item.allowDownload);
          togglePlayPause(true);
          throttledSaveState();
        }
      });
      div.querySelector('.item-play-pause').addEventListener('click', (e) => {
        e.stopPropagation();
        if (item.mediaUrl !== currentMedia?.mediaUrl) {
          currentIndex = index;
          loadMedia(item.mediaUrl, item.mediaType, item.coverUrlContainer, item.coverUrlInfo, item.title, item.detailUrl, item.author, item.next, item.text, item.allowDownload);
        }
        togglePlayPause();
      });
      playlistItems.appendChild(div);
    });
    document.querySelectorAll('.remove-playlist-item').forEach(button => {
      button.addEventListener('click', (e) => {
        e.stopPropagation();
        const index = parseInt(e.target.closest('button').dataset.index);
        playlist.splice(index, 1);
        localStorage.setItem('playlist', JSON.stringify(playlist));
        if (index <= currentIndex) {
          currentIndex--;
        }
        updatePlaylist();
        updateAddButton();
      });
    });
    setupPlaylistDrag();
  } else {
    playlistItems.innerHTML = '<div class="no-items">No has agregado tus episodios</div>';
  }
};
const setupPlaylistDrag = () => {
  const items = playlistItems.querySelectorAll('.playlist-item');
  items.forEach(item => {
    item.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', item.dataset.index);
      item.classList.add('dragging');
    });
    item.addEventListener('dragend', (e) => {
      item.classList.remove('dragging');
    });
    item.addEventListener('dragover', (e) => {
      e.preventDefault();
      const dragging = playlistItems.querySelector('.dragging');
      if (dragging !== item) {
        const from = parseInt(dragging.dataset.index);
        const to = parseInt(item.dataset.index);
        if (from < to) {
          item.after(dragging);
        } else {
          item.before(dragging);
        }
        const newItems = playlistItems.querySelectorAll('.playlist-item');
        newItems.forEach((it, idx) => it.dataset.index = idx);
        const temp = playlist[from];
        playlist.splice(from, 1);
        playlist.splice(to, 0, temp);
        localStorage.setItem('playlist', JSON.stringify(playlist));
        currentIndex = playlist.findIndex(p => p.mediaUrl === currentMedia.mediaUrl);
      }
    });
    item.addEventListener('drop', (e) => {
      e.preventDefault();
    });
    item.addEventListener('touchstart', (e) => {
      if (e.target.closest('.drag-handle')) {
        item.classList.add('dragging');
      }
    });
    item.addEventListener('touchmove', (e) => {
      if (item.classList.contains('dragging')) {
        e.preventDefault();
      }
    });
    item.addEventListener('touchend', (e) => {
      item.classList.remove('dragging');
    });
  });
};
const updateNextList = () => {
  nextItems.innerHTML = '';
  if (nextList.length > 0) {
    nextList.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'next-item';
      if (item.mediaUrl === currentMedia?.mediaUrl) {
        div.classList.add('active');
      }
      div.innerHTML = `
        <img class="cover" src="${item.coverUrlInfo || 'https://via.placeholder.com/30'}" alt="Cover" loading="lazy">
        <span>${item.title}</span>
        <div class="item-controls">
          <button class="item-play-pause">
            <img src="${(item.mediaUrl === currentMedia?.mediaUrl) ? (mediaElement.paused ? 'https://marca1.odoo.com/web/image/508-f876320c/play.svg' : 'https://nikichitonjesus.odoo.com/web/image/983-5c0bffd9/Pause.webp') : 'https://marca1.odoo.com/web/image/508-f876320c/play.svg'}" alt="Play/Pause" loading="lazy">
          </button>
        </div>
      `;
      div.addEventListener('click', (e) => {
        e.stopPropagation();
        currentIndex = index;
        loadMedia(item.mediaUrl, item.mediaType, item.coverUrlContainer, item.coverUrlInfo, item.title, item.detailUrl, item.author, nextList, item.text, item.allowDownload);
        togglePlayPause(true);
        throttledSaveState();
      });
      div.querySelector('.item-play-pause').addEventListener('click', (e) => {
        e.stopPropagation();
        if (item.mediaUrl !== currentMedia?.mediaUrl) {
          currentIndex = index;
          loadMedia(item.mediaUrl, item.mediaType, item.coverUrlContainer, item.coverUrlInfo, item.title, item.detailUrl, item.author, nextList, item.text, item.allowDownload);
        }
        togglePlayPause();
      });
      nextItems.appendChild(div);
    });
  } else {
    nextItems.innerHTML = '<div class="no-items">Episodio único</div>';
  }
};

// CORREGIDA: updateRecomendadosList() - Cachea orden y maneja click para continuar en orden
const updateRecomendadosList = () => {
  // NUEVO: Cachea recomendados frescos cada vez que se actualiza la lista (pero preserva orden)
  if (cachedRecomendados.length === 0) {
    cachedRecomendados = [...window.RECOMENDADOS];
  }
  recomendadosItems.innerHTML = '';
  if (cachedRecomendados.length > 0) {
    recomendadosSeparator.style.display = 'block';
    cachedRecomendados.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'next-item';
      div.innerHTML = `
        <img class="cover" src="${item.coverUrl || 'https://via.placeholder.com/30'}" alt="Cover" loading="lazy">
        <span>${item.title}</span>
        <div class="item-controls">
          <button class="item-play-pause">
            <img src="${(item.mediaUrl === currentMedia?.mediaUrl) ? (mediaElement.paused ? 'https://marca1.odoo.com/web/image/508-f876320c/play.svg' : 'https://nikichitonjesus.odoo.com/web/image/983-5c0bffd9/Pause.webp') : 'https://marca1.odoo.com/web/image/508-f876320c/play.svg'}" alt="Play/Pause" loading="lazy">
          </button>
        </div>
      `;
      // CORREGIDO: Al click, carga como desde recomendados con index para continuar orden
      div.addEventListener('click', (e) => {
        e.stopPropagation();
        const mappedItem = mapEpisodeToMedia(item);
        loadMedia(
          mappedItem.mediaUrl,
          mappedItem.mediaType,
          mappedItem.coverUrlContainer,
          mappedItem.coverUrlInfo,
          mappedItem.title,
          mappedItem.detailUrl,
          mappedItem.author,
          mappedItem.next,
          mappedItem.text,
          mappedItem.allowDownload,
          true, // isFromRecomendados
          index // recIndex
        );
        togglePlayPause(true);
        throttledSaveState();
      });
      div.querySelector('.item-play-pause').addEventListener('click', (e) => {
        e.stopPropagation();
        if (item.mediaUrl !== currentMedia?.mediaUrl) {
          const mappedItem = mapEpisodeToMedia(item);
          loadMedia(
            mappedItem.mediaUrl,
            mappedItem.mediaType,
            mappedItem.coverUrlContainer,
            mappedItem.coverUrlInfo,
            mappedItem.title,
            mappedItem.detailUrl,
            mappedItem.author,
            mappedItem.next,
            mappedItem.text,
            mappedItem.allowDownload,
            true,
            index
          );
        }
        togglePlayPause();
      });
      recomendadosItems.appendChild(div);
    });
  } else {
    recomendadosSeparator.style.display = 'none';
  }
};
const updateTextContent = () => {
  textContent.innerHTML = `<h4>${currentMedia?.title || ''}</h4><p>${episodeText || 'No hay texto disponible'}</p>`;
};
const showExpanded = () => {
  isExpanded = true;
  isHidden = false;
  playerExpanded.style.display = 'flex';
  playerMinimized.style.display = 'none';
  throttledSaveState();
  updatePlaylist();
  updateLikes();
  updateNextList();
  updateRecomendadosList();
  updateTextContent();
  checkTitleOverflow();
  checkMinimizedTitleOverflow();
};
const showMinimized = () => {
  isExpanded = false;
  isHidden = false;
  playerExpanded.style.display = 'none';
  playerMinimized.style.display = 'flex';
  panelContainer.style.display = 'none';
  throttledSaveState();
  checkTitleOverflow();
  checkMinimizedTitleOverflow();
};
const hidePlayer = () => {
  isHidden = true;
  playerExpanded.style.display = 'none';
  playerMinimized.style.display = 'none';
  panelContainer.style.display = 'none';
  throttledSaveState();
};
const togglePanel = (tab = 'cola') => {
  const wasVisible = panelContainer.style.display === 'flex';
  panelContainer.style.display = wasVisible ? 'none' : 'flex';
  if (panelContainer.style.display === 'flex') {
    const group = getGroup(tab);
    updateVisibleTabs(group);
    switchTab(tab);
    closePanelBtn.classList.add('visible');
    isPanelFullHeight = false;
    panelContainer.classList.remove('full-height');
    togglePanelHeightBtn.querySelector('img').src = 'https://marca1.odoo.com/web/image/513-e0bcd17f/maz.svg';
    minimizeBtn.style.position = 'fixed';
    minimizeBtn.style.bottom = 'auto';
    minimizeBtn.style.top = 'max(12px, env(safe-area-inset-top))';
  } else {
    closePanelBtn.classList.remove('visible');
  }
};
const togglePanelHeight = () => {
  isPanelFullHeight = !isPanelFullHeight;
  panelContainer.classList.toggle('full-height', isPanelFullHeight);
  togglePanelHeightBtn.querySelector('img').src = isPanelFullHeight ? 'https://marca1.odoo.com/web/image/514-efa5e8dd/minimizar.svg' : 'https://marca1.odoo.com/web/image/513-e0bcd17f/maz.svg';
  if (isPanelFullHeight) {
    minimizeBtn.style.position = 'absolute';
    minimizeBtn.style.bottom = '10px';
    minimizeBtn.style.top = 'auto';
  } else {
    minimizeBtn.style.position = 'fixed';
    minimizeBtn.style.bottom = 'auto';
    minimizeBtn.style.top = 'max(12px, env(safe-area-inset-top))';
  }
};
const switchTab = (tab) => {
  document.querySelectorAll('.tabs a').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel-section').forEach(s => s.classList.remove('active'));
  if (tab === 'cola') {
    tabCola.classList.add('active');
    colaContent.classList.add('active');
  } else if (tab === 'detalles') {
    tabDetalles.classList.add('active');
    detallesContent.classList.add('active');
  } else if (tab === 'biblioteca') {
    tabBiblioteca.classList.add('active');
    bibliotecaContent.classList.add('active');
  } else if (tab === 'velocidad') {
    tabVelocidad.classList.add('active');
    velocidadContent.classList.add('active');
  } else if (tab === 'temporizador') {
    tabTemporizador.classList.add('active');
    temporizadorContent.classList.add('active');
    updateTimerView();
  }
};
const updateTimerView = () => {
  if (timerValue !== 0 && timerValue !== '0') {
    timerCountdown.style.display = 'flex';
    timerOptions.style.display = 'none';
  } else {
    timerCountdown.style.display = 'none';
    timerOptions.style.display = 'block';
  }
};
const updateIcons = (isPlaying) => {
  const playIcon = 'https://marca1.odoo.com/web/image/508-f876320c/play.svg';
  const pauseIcon = 'https://nikichitonjesus.odoo.com/web/image/983-5c0bffd9/Pause.webp';
  loadImageWithFallback(playPauseIconExpanded, isPlaying ? pauseIcon : playIcon, isPlaying ? 'Pause' : 'Play', 'https://via.placeholder.com/24');
  loadImageWithFallback(playPauseIconMinimized, isPlaying ? pauseIcon : playIcon, isPlaying ? 'Pause' : 'Play', 'https://via.placeholder.com/24');
  loadImageWithFallback(playPauseIconMedia, isPlaying ? pauseIcon : playIcon, isPlaying ? 'Pause' : 'Play', 'https://via.placeholder.com/24');
  loadImageWithFallback(playPauseIconFullscreen, isPlaying ? pauseIcon : playIcon, isPlaying ? 'Pause' : 'Play', 'https://via.placeholder.com/24');
};
const updateAllItemIcons = (isPlaying) => {
  document.querySelectorAll('.item-play-pause img').forEach(icon => {
    const item = icon.closest('.playlist-item, .next-item');
    const isCurrent = item.classList.contains('active');
    loadImageWithFallback(icon, isCurrent ? (isPlaying ? 'https://nikichitonjesus.odoo.com/web/image/983-5c0bffd9/Pause.webp' : 'https://nikichitonjesus.odoo.com/web/image/984-ba35a699/play.webp') : 'https://marca1.odoo.com/web/image/508-f876320c/play.svg', isPlaying ? 'Pause' : 'Play', 'https://via.placeholder.com/20');
  });
};
const togglePlayPause = (forcePlay = false) => {
  if (mediaElement.dataset.isToggling === 'true') return;
  mediaElement.dataset.isToggling = 'true';
  if (forcePlay || mediaElement.paused) {
    playWithFallback();
  } else {
    mediaElement.pause();
    updateIcons(false);
    updateAllItemIcons(false);
  }
  checkMute();
  throttledSaveState();
  setTimeout(() => {
    mediaElement.dataset.isToggling = 'false';
  }, 100);
};
const rewind = (seconds = 15) => {
  if (isNaN(mediaElement.duration)) return;
  mediaElement.currentTime = Math.max(0, mediaElement.currentTime - seconds);
  showSeekIndicator('left', seconds);
  throttledSaveState();
};
const forward = (seconds = 15) => {
  if (isNaN(mediaElement.duration)) return;
  mediaElement.currentTime = Math.min(mediaElement.duration, mediaElement.currentTime + seconds);
  showSeekIndicator('right', seconds);
  throttledSaveState();
};

// CORREGIDA: previous() - Prioridad: playlist > next > history
const previous = () => {
  if (repeatMode !== 0) return; // Solo en modo normal (autoplay)
  if (activeList === 'playlist' && userPlaylistAutoPlay && currentIndex > 0) {
    currentIndex--;
    const item = playlist[currentIndex];
    loadMedia(item.mediaUrl, item.mediaType, item.coverUrlContainer, item.coverUrlInfo, item.title, item.detailUrl, item.author, playlist, item.text, item.allowDownload);
    togglePlayPause(true);
  } else if (activeList === 'next' && currentIndex > 0) {
    currentIndex--;
    const item = nextList[currentIndex];
    loadMedia(item.mediaUrl, item.mediaType, item.coverUrlContainer, item.coverUrlInfo, item.title, item.detailUrl, item.author, nextList, item.text, item.allowDownload);
    togglePlayPause(true);
  } else if (historyList.length > 0) {
    const prevItem = historyList.pop();
    loadMedia(prevItem.mediaUrl, prevItem.mediaType, prevItem.coverUrlContainer, prevItem.coverUrlInfo, prevItem.title, prevItem.detailUrl, prevItem.author, prevItem.next, prevItem.text, prevItem.allowDownload);
    togglePlayPause(true);
  } else {
    mediaElement.currentTime = 0;
  }
  throttledSaveState();
};

// CORREGIDA: next() - Prioridad: cola > playlist (si autoplay) > recomendados (en orden cacheado)
const next = () => {
  if (repeatMode !== 0) return; // Solo en modo normal (autoplay)
  if (activeList === 'next' && currentIndex < nextList.length - 1) {
    currentIndex++;
    const item = nextList[currentIndex];
    loadMedia(item.mediaUrl, item.mediaType, item.coverUrlContainer, item.coverUrlInfo, item.title, item.detailUrl, item.author, nextList, item.text, item.allowDownload);
    togglePlayPause(true);
  } else if (activeList === 'playlist' && userPlaylistAutoPlay && currentIndex < playlist.length - 1) {
    currentIndex++;
    const item = playlist[currentIndex];
    loadMedia(item.mediaUrl, item.mediaType, item.coverUrlContainer, item.coverUrlInfo, item.title, item.detailUrl, item.author, playlist, item.text, item.allowDownload);
    togglePlayPause(true);
  } else if (userPlaylistAutoPlay && playlist.length > 0) {
    // Reinicia playlist si autoplay activado
    activeList = 'playlist';
    currentIndex = 0;
    const item = playlist[currentIndex];
    loadMedia(item.mediaUrl, item.mediaType, item.coverUrlContainer, item.coverUrlInfo, item.title, item.detailUrl, item.author, playlist, item.text, item.allowDownload);
    togglePlayPause(true);
  } else if (cachedRecomendados.length > 0) {
    // Continúa con el siguiente de recomendados (shift preserva orden)
    const nextRecItem = cachedRecomendados.shift();
    const mappedRec = mapEpisodeToMedia(nextRecItem);
    loadMedia(
      mappedRec.mediaUrl,
      mappedRec.mediaType,
      mappedRec.coverUrlContainer,
      mappedRec.coverUrlInfo,
      mappedRec.title,
      mappedRec.detailUrl,
      mappedRec.author,
      cachedRecomendados.map(mapEpisodeToMedia), // Resto como cola
      mappedRec.text,
      mappedRec.allowDownload,
      true, // isFromRecomendados
      0 // index 0 en la nueva cola
    );
    togglePlayPause(true);
  }
  throttledSaveState();
};

// CORREGIDA: handleMediaEnd() - Similar a next(), pero con repeat
const handleMediaEnd = () => {
  if (repeatMode === 2) {
    mediaElement.play();
  } else if (repeatMode === 1) {
    mediaElement.play();
    repeatMode = 0;
    updateRepeatButton();
  } else {
    // Modo normal: autoplay según prioridad
    if (activeList === 'next' && currentIndex < nextList.length - 1) {
      currentIndex++;
      const nextItem = nextList[currentIndex];
      loadMedia(nextItem.mediaUrl, nextItem.mediaType, nextItem.coverUrlContainer, nextItem.coverUrlInfo, nextItem.title, nextItem.detailUrl, nextItem.author, nextList, nextItem.text, nextItem.allowDownload);
      togglePlayPause(true);
    } else if (activeList === 'playlist' && userPlaylistAutoPlay && currentIndex < playlist.length - 1) {
      currentIndex++;
      const nextItem = playlist[currentIndex];
      loadMedia(nextItem.mediaUrl, nextItem.mediaType, nextItem.coverUrlContainer, nextItem.coverUrlInfo, nextItem.title, nextItem.detailUrl, nextItem.author, playlist, nextItem.text, nextItem.allowDownload);
      togglePlayPause(true);
    } else if (userPlaylistAutoPlay && playlist.length > 0) {
      // Reinicia playlist
      activeList = 'playlist';
      currentIndex = 0;
      const nextItem = playlist[currentIndex];
      loadMedia(nextItem.mediaUrl, nextItem.mediaType, nextItem.coverUrlContainer, nextItem.coverUrlInfo, nextItem.title, nextItem.detailUrl, nextItem.author, playlist, nextItem.text, nextItem.allowDownload);
      togglePlayPause(true);
    } else if (cachedRecomendados.length > 0) {
      // Continúa con recomendados
      const nextRecItem = cachedRecomendados.shift();
      const mappedRec = mapEpisodeToMedia(nextRecItem);
      loadMedia(
        mappedRec.mediaUrl,
        mappedRec.mediaType,
        mappedRec.coverUrlContainer,
        mappedRec.coverUrlInfo,
        mappedRec.title,
        mappedRec.detailUrl,
        mappedRec.author,
        cachedRecomendados.map(mapEpisodeToMedia),
        mappedRec.text,
        mappedRec.allowDownload,
        true,
        0
      );
      togglePlayPause(true);
    }
  }
  throttledSaveState();
};

const handleMediaTap = (e) => {
  if (e.target.closest('button')) return;
  e.preventDefault();
  e.stopPropagation();
  const now = Date.now();
  if (now - lastTapTime < 250) {
    tapCount++;
  } else {
    tapCount = 1;
  }
  lastTapTime = now;
  const rect = mediaContainer.getBoundingClientRect();
  let x;
  if (e.changedTouches) {
    x = e.changedTouches[0].clientX - rect.left;
  } else {
    x = e.clientX - rect.left;
  }
  tapSide = x < rect.width / 2 ? 'left' : 'right';
  if (tapTimeout) clearTimeout(tapTimeout);
  tapTimeout = setTimeout(() => {
    if (tapCount === 1) {
      showControls = !showControls;
      mediaContainer.classList.toggle('show-controls', showControls);
      if (showControls) {
        muteIndicator.style.display = 'none';
      } else if (isAutoMuted && !isUserMuted) {
        showMuteIndicator();
      }
    } else if (tapCount > 1) {
      const seconds = 15 * (tapCount - 1);
      if (tapSide === 'left') {
        rewind(seconds);
      } else {
        forward(seconds);
      }
    }
    tapCount = 0;
  }, 250);
};
let autoHideTimer = null;
const handleFullscreenTap = (e) => {
  if (!isFullscreenMode || e.target.closest('button')) return;
  e.preventDefault();
  e.stopPropagation();
  const isShown = fullscreenControls.classList.toggle('show-controls');
  if (isShown) {
    startAutoHideTimer();
  }
};
const startAutoHideTimer = () => {
  clearTimeout(autoHideTimer);
  autoHideTimer = setTimeout(() => {
    if (isFullscreenMode) {
      fullscreenControls.classList.remove('show-controls');
    } else {
      mediaContainer.classList.remove('show-controls');
    }
  }, 3000);
};
const showSeekIndicator = (side, seconds) => {
  const indicator = side === 'left' ? seekIndicatorLeft : seekIndicatorRight;
  const secondsElem = side === 'left' ? seekSecondsLeft : seekSecondsRight;
  secondsElem.textContent = `${seconds}s`;
  indicator.classList.add('show');
  setTimeout(() => indicator.classList.remove('show'), 1000);
};
const updateProgress = () => {
  if (!mediaElement.duration) return;
  const percentage = (mediaElement.currentTime / mediaElement.duration) * 100;
  progressBarExpanded.style.width = percentage + '%';
  progressBarMinimized.style.width = percentage + '%';
  progressBarFullscreen.style.width = percentage + '%';
  currentTimeExpanded.textContent = formatTime(mediaElement.currentTime);
  durationExpanded.textContent = formatTime(mediaElement.duration);
  currentTimeFullscreen.textContent = formatTime(mediaElement.currentTime);
  durationFullscreen.textContent = formatTime(mediaElement.duration);
  throttledSaveState();
};
const formatTime = (seconds) => {
  if (isNaN(seconds)) return "00:00";
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
};
const updateProgressDrag = (clientX, container, progressBar) => {
  const rect = container.getBoundingClientRect();
  const x = clientX - rect.left;
  const width = rect.width;
  let percentage = (x / width) * 100;
  percentage = Math.max(0, Math.min(100, percentage));
  progressBar.style.width = percentage + '%';
  if (mediaElement.duration) {
    mediaElement.currentTime = (percentage / 100) * mediaElement.duration;
  }
  throttledSaveState();
};
const updateSpeedButtons = (value) => {
  currentSpeed.textContent = `${value}x`;
  if (value !== 1) {
    speedContainer.classList.add('active');
  } else {
    speedContainer.classList.remove('active');
  }
};
const setupTimer = () => {
  if (timerId) clearTimeout(timerId);
  if (timerCountdownInterval) clearInterval(timerCountdownInterval);
  if (timerValue === 'end') {
    currentEpisodeId = currentMedia.mediaUrl;
    const updateEndTimer = () => {
      const remaining = mediaElement.duration - mediaElement.currentTime;
      if (remaining <= 0 && currentEpisodeId === currentMedia.mediaUrl) {
        mediaElement.pause();
        resetTimer();
      }
    };
    mediaElement.addEventListener('timeupdate', updateEndTimer);
    timerCountdownInterval = setInterval(() => {
      countdownDisplay.textContent = formatTime(mediaElement.duration - mediaElement.currentTime);
    }, 1000);
  } else if (timerValue !== '0') {
    const minutes = parseInt(timerValue);
    let remaining = minutes * 60;
    timerId = setTimeout(() => {
      mediaElement.pause();
      resetTimer();
    }, remaining * 1000);
    timerCountdownInterval = setInterval(() => {
      remaining--;
      countdownDisplay.textContent = formatTime(remaining);
      if (remaining <= 0) clearInterval(timerCountdownInterval);
    }, 1000);
  }
  updateTimerButtons(timerValue);
  if (timerValue !== '0') timerContainer.classList.add('active');
};
const resetTimer = () => {
  if (timerId) clearTimeout(timerId);
  if (timerCountdownInterval) clearInterval(timerCountdownInterval);
  timerValue = 0;
  timerId = null;
  timerCountdownInterval = null;
  currentEpisodeId = null;
  timerContainer.classList.remove('active');
  timerCountdown.style.display = 'none';
  timerOptions.style.display = 'block';
  updateTimerButtons(0);
  throttledSaveState();
};
const updateTimerButtons = (value) => {
  timerOptions.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
  const btn = timerOptions.querySelector(`button[data-value="${value}"]`);
  if (btn) btn.classList.add('selected');
};
const checkTitleOverflow = () => {
  [episodeTitle].forEach(title => {
    if (!title) return;
    const parent = title.parentElement;
    if (!parent) return;
    title.classList.remove('scrolling-title');
    title.style.animation = 'none';
    requestAnimationFrame(() => {
      const availableWidth = parent.offsetWidth;
      if (title.scrollWidth > availableWidth) {
        title.classList.add('scrolling-title');
        title.style.animation = 'scrollTitle 40s linear infinite';
      }
    });
  });
};
const checkMinimizedTitleOverflow = () => {
  const title = episodeTitleMinimized;
  const parent = title.parentElement;
  if (!parent) return;
  title.classList.remove('scrolling');
  title.style.animation = 'none';
  requestAnimationFrame(() => {
    const availableWidth = parent.offsetWidth;
    if (title.scrollWidth > availableWidth) {
      title.classList.add('scrolling');
      title.style.animation = 'scrollMinimizedTitle 20s linear infinite';
    }
  });
};
const checkMute = () => {
  isMuted = mediaElement.muted;
  isUserMuted = !isAutoMuted && isMuted;
  const volumeIconSrc = isMuted ? 'https://nikichitonjesus.odoo.com/web/image/584-d2f5c35f/mute.png' : 'https://nikichitonjesus.odoo.com/web/image/587-e4437449/volumen.png';
  loadImageWithFallback(volumeIcon, volumeIconSrc, isMuted ? 'Muted' : 'Volume', 'https://via.placeholder.com/24');
  loadImageWithFallback(volumeIconFullscreen, volumeIconSrc, isMuted ? 'Muted' : 'Volume', 'https://via.placeholder.com/24');
  showMuteIndicator();
  throttledSaveState();
};
const updateRepeatButton = () => {
  const span = repeatBtn.querySelector('span');
  if (repeatMode === 0) {
    span.textContent = 'Repetir';
  } else if (repeatMode === 1) {
    span.textContent = 'Repetir una vez';
  } else {
    span.textContent = 'Repetir infinito';
  }
  repeatBtn.classList.toggle('repeat-active', repeatMode > 0);
};
mediaContainer.addEventListener('mouseenter', () => {
  if (isFullscreenMode) return;
  mediaContainer.classList.add('show-controls');
  startAutoHideTimer();
});
mediaContainer.addEventListener('mousemove', startAutoHideTimer);
mediaContainer.addEventListener('click', handleFullscreenTap);
mediaContainer.addEventListener('touchend', handleFullscreenTap);
mediaElement.addEventListener('timeupdate', updateProgress);
mediaElement.addEventListener('loadedmetadata', updateProgress);
mediaElement.addEventListener('ended', handleMediaEnd);
mediaElement.addEventListener('play', () => { updateIcons(true); updateAllItemIcons(true); });
mediaElement.addEventListener('pause', () => { updateIcons(false); updateAllItemIcons(false); });
mediaContainer.addEventListener('touchend', handleMediaTap);
mediaContainer.addEventListener('click', handleMediaTap);
speedContainer.addEventListener('click', (e) => {
  e.stopPropagation();
  togglePanel('velocidad');
});
speedContainer.addEventListener('touchend', (e) => {
  e.stopPropagation();
  e.preventDefault();
  togglePanel('velocidad');
});
timerContainer.addEventListener('click', (e) => {
  e.stopPropagation();
  togglePanel('temporizador');
  setTimeout(updateTimerView, 100); // Pequeño delay para asegurar que el panel esté abierto
});
timerContainer.addEventListener('touchend', (e) => {
  e.stopPropagation();
  e.preventDefault();
  togglePanel('temporizador');
  setTimeout(updateTimerView, 100);
});
speedSlider.addEventListener('input', () => {
  const value = parseFloat(speedSlider.value);
  mediaElement.playbackRate = value;
  updateSpeedButtons(value);
  throttledSaveState();
});
timerOptions.querySelectorAll('button').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    timerValue = btn.dataset.value;
    setupTimer();
    togglePanel();
    throttledSaveState();
      updateTimerView();
  });
});
deactivateTimer.addEventListener('click', (e) => {
  e.stopPropagation();
  resetTimer();
  togglePanel();
    updateTimerView();
});
minimizeBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  e.preventDefault();
  showMinimized();
});
minimizeBtn.addEventListener('touchend', (e) => {
  e.stopPropagation();
  e.preventDefault();
  showMinimized();
});
expandBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  e.preventDefault();
  showExpanded();
});
expandBtn.addEventListener('touchend', (e) => {
  e.stopPropagation();
  e.preventDefault();
  showExpanded();
});
playerMinimized.addEventListener('click', (e) => {
  if (!progressContainerMinimized.contains(e.target) && !e.target.closest('.minimized-controls')) {
    showExpanded();
  }
});
episodeInfo.addEventListener('click', (e) => {
  if (e.target.closest('#addToPlaylistBtn')) return;
  if (currentMedia?.detailUrl) {
    window.location.href = currentMedia.detailUrl;
  }
});
mediaModeToggle.addEventListener('click', (e) => {
  e.stopPropagation();
  toggleMediaMode();
});
fullscreenBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  if (!document.fullscreenElement) {
    mediaContainer.requestFullscreen().then(() => {
      isFullscreenMode = true;
      fullscreenControls.style.display = 'flex';
      loadImageWithFallback(fullscreenBtn.querySelector('img'), 'https://nikichitonjesus.odoo.com/web/image/623-e47eb360/Exitfull.png', 'Exit Fullscreen', 'https://via.placeholder.com/24');
      if (screen.orientation && screen.orientation.lock) {
        screen.orientation.lock('landscape').catch(() => {});
      }
      overlayGradient.style.display = 'none';
      mediaContainer.classList.remove('show-controls');
      startAutoHideTimer();
    }).catch(err => console.log('Fullscreen error:', err));
  } else {
    document.exitFullscreen().then(() => {
      isFullscreenMode = false;
      fullscreenControls.style.display = 'none';
      loadImageWithFallback(fullscreenBtn.querySelector('img'), 'https://www.nikichitonjesus.org/web/image/465-b35c8fea/full.webp', 'Fullscreen', 'https://via.placeholder.com/24');
      overlayGradient.style.display = 'flex';
    });
  }
});
exitFullscreenBtn.addEventListener('click', (e) => {
  e.preventDefault();
  e.stopPropagation();
  if (document.fullscreenElement) {
    document.exitFullscreen();
  }
});
exitFullscreenBtn.addEventListener('touchend', (e) => {
  e.preventDefault();
  e.stopPropagation();
  if (document.fullscreenElement) {
    document.exitFullscreen();
  }
});
document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement) {
    isFullscreenMode = false;
    fullscreenControls.style.display = 'none';
    loadImageWithFallback(fullscreenBtn.querySelector('img'), 'https://www.nikichitonjesus.org/web/image/465-b35c8fea/full.webp', 'Fullscreen', 'https://via.placeholder.com/24');
    overlayGradient.style.display = 'flex';
    clearTimeout(autoHideTimer);
  } else {
    fullscreenControls.style.display = 'flex';
    overlayGradient.style.display = 'none';
    startAutoHideTimer();
  }
});
previousFullscreen.addEventListener('click', (e) => {
  e.stopPropagation();
  previous();
});
rewindFullscreen.addEventListener('click', (e) => {
  e.stopPropagation();
  rewind();
});
playPauseFullscreen.addEventListener('click', (e) => {
  e.stopPropagation();
  togglePlayPause();
});
forwardFullscreen.addEventListener('click', (e) => {
  e.stopPropagation();
  forward();
});
nextFullscreen.addEventListener('click', (e) => {
  e.stopPropagation();
  next();
});
volumeFullscreen.addEventListener('click', (e) => {
  e.stopPropagation();
  mediaElement.muted = !mediaElement.muted;
  checkMute();
});
volumeBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  mediaElement.muted = !mediaElement.muted;
  checkMute();
});
playPauseMedia.addEventListener('click', (e) => {
  e.stopPropagation();
  togglePlayPause();
});
downloadBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  if (!currentMedia.allowDownload) return;
  downloadBtn.classList.add('active');
  setTimeout(() => downloadBtn.classList.remove('active'), 200);
  if (currentMedia?.mediaUrl) {
    const link = document.createElement('a');
    link.href = currentMedia.mediaUrl;
    link.target = '_blank';
    link.download = currentMedia.title || 'media';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  } else {
    alert('No hay archivo para descargar.');
  }
});
shareBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  shareBtn.classList.add('active');
  setTimeout(() => shareBtn.classList.remove('active'), 200);
  if (currentMedia?.title && currentMedia?.detailUrl) {
    if (navigator.share && typeof navigator.share === 'function') {
      navigator.share({
        title: currentMedia.title,
        url: currentMedia.detailUrl,
      }).catch((error) => {
        console.log('Error al compartir:', error);
      });
    } else {
      navigator.clipboard.writeText(`${currentMedia.title}: ${currentMedia.detailUrl}`)
        .then(() => alert('Enlace copiado al portapapeles'))
        .catch(() => alert('Error al copiar el enlace'));
    }
  } else {
    alert('No hay contenido para compartir.');
  }
});
programBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  const programa = window.PROGRAMA_DEL_DIA || {
    mediaUrl: 'https://awscdn.podcasts.com/audio-vhhlggMJNysHnLYW8KXAQwu4w.mp3',
    mediaType: 'audio',
    coverUrlContainer: 'https://s3.amazonaws.com/podcasts-image-uploads/el-populismo-y-la-democracia-jesus-huerta-de-soto-1400x1400.png',
    coverUrlInfo: 'https://www.edu.balta.lat/web/image/415-8ae27244/media.png',
    title: 'El populismo y la democracia',
    detailUrl: '#',
    author: "Jesús Huerta de Soto",
    text: "No disponible",
    allowDownload: true
  };
  loadMedia(programa.mediaUrl, programa.mediaType, programa.coverUrlContainer, programa.coverUrlInfo, programa.title, programa.detailUrl, programa.author, [], programa.text, programa.allowDownload);
  showExpanded();
  togglePlayPause(true);
  throttledSaveState();
});
repeatBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  repeatBtn.classList.add('active');
  setTimeout(() => repeatBtn.classList.remove('active'), 200);
  repeatMode = (repeatMode + 1) % 3;
  mediaElement.loop = repeatMode === 2;
  updateRepeatButton();
  throttledSaveState();
});
addToPlaylistBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  addToPlaylistBtn.classList.add('active');
  setTimeout(() => addToPlaylistBtn.classList.remove('active'), 200);
  if (currentMedia && !playlist.some(item => item.mediaUrl === currentMedia.mediaUrl)) {
    playlist.push(currentMedia);
    localStorage.setItem('playlist', JSON.stringify(playlist));
    updatePlaylist();
    updateAddButton();
  } else if (currentMedia) {
    const index = playlist.findIndex(item => item.mediaUrl === currentMedia.mediaUrl);
    if (index > -1) {
      playlist.splice(index, 1);
      localStorage.setItem('playlist', JSON.stringify(playlist));
      updatePlaylist();
      updateAddButton();
    }
  } else {
    alert('No hay episodio cargado.');
  }
  throttledSaveState();
});
likesBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  toggleLikes();
});
colaBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  togglePanel('cola');
});
detallesBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  togglePanel('detalles');
});
bibliotecaBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  togglePanel('biblioteca');
});
linkCola.addEventListener('click', (e) => {
  e.stopPropagation();
  e.preventDefault();
  togglePanel('cola');
});
linkCola.addEventListener('touchend', (e) => {
  e.stopPropagation();
  e.preventDefault();
  togglePanel('cola');
});
linkDetalles.addEventListener('click', (e) => {
  e.stopPropagation();
  e.preventDefault();
  togglePanel('detalles');
});
linkDetalles.addEventListener('touchend', (e) => {
  e.stopPropagation();
  e.preventDefault();
  togglePanel('detalles');
});
linkBiblioteca.addEventListener('click', (e) => {
  e.stopPropagation();
  e.preventDefault();
  togglePanel('biblioteca');
});
linkBiblioteca.addEventListener('touchend', (e) => {
  e.stopPropagation();
  e.preventDefault();
  togglePanel('biblioteca');
});
closePanelBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  togglePanel();
});
togglePanelHeightBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  togglePanelHeight();
});
tabCola.addEventListener('click', (e) => {
  e.stopPropagation();
  switchTab('cola');
});
tabDetalles.addEventListener('click', (e) => {
  e.stopPropagation();
  switchTab('detalles');
});
tabBiblioteca.addEventListener('click', (e) => {
  e.stopPropagation();
  switchTab('biblioteca');
});
tabVelocidad.addEventListener('click', (e) => {
  e.stopPropagation();
  switchTab('velocidad');
});
tabTemporizador.addEventListener('click', (e) => {
  e.stopPropagation();
  switchTab('temporizador');
});
viewAllLikes.addEventListener('click', (e) => {
  e.stopPropagation();
  toggleLikesView();
});
playUserPlaylistBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  userPlaylistAutoPlay = !userPlaylistAutoPlay;
  playUserPlaylistBtn.classList.toggle('active', userPlaylistAutoPlay);
  if (userPlaylistAutoPlay && playlist.length > 0) {
    activeList = 'playlist';
    currentIndex = 0;
    const item = playlist[currentIndex];
    loadMedia(item.mediaUrl, item.mediaType, item.coverUrlContainer, item.coverUrlInfo, item.title, item.detailUrl, item.author, playlist, item.text, item.allowDownload); // Usa playlist como next
    togglePlayPause(true);
  } else if (!userPlaylistAutoPlay) {
    activeList = 'next';
  }
  throttledSaveState();
});
mediaElement.addEventListener('volumechange', checkMute);
rewindExpanded.addEventListener('click', (e) => {
  e.stopPropagation();
  rewind();
});
rewindExpanded.addEventListener('touchend', (e) => {
  e.stopPropagation();
  e.preventDefault();
  rewind();
});
forwardExpanded.addEventListener('click', (e) => {
  e.stopPropagation();
  forward();
});
forwardExpanded.addEventListener('touchend', (e) => {
  e.stopPropagation();
  e.preventDefault();
  forward();
});
previousExpanded.addEventListener('click', (e) => {
  e.stopPropagation();
  previous();
});
previousExpanded.addEventListener('touchend', (e) => {
  e.stopPropagation();
  e.preventDefault();
  previous();
});
nextExpanded.addEventListener('click', (e) => {
  e.stopPropagation();
  next();
});
nextExpanded.addEventListener('touchend', (e) => {
  e.stopPropagation();
  e.preventDefault();
  next();
});
playPauseExpanded.addEventListener('click', (e) => {
  e.stopPropagation();
  togglePlayPause();
});
playPauseExpanded.addEventListener('touchend', (e) => {
  e.stopPropagation();
  e.preventDefault();
  togglePlayPause();
});
rewindMinimized.addEventListener('click', (e) => {
  e.stopPropagation();
  e.preventDefault();
  rewind();
});
rewindMinimized.addEventListener('touchend', (e) => {
  e.stopPropagation();
  e.preventDefault();
  rewind();
});
forwardMinimized.addEventListener('click', (e) => {
  e.stopPropagation();
  e.preventDefault();
  forward();
});
forwardMinimized.addEventListener('touchend', (e) => {
  e.stopPropagation();
  e.preventDefault();
  forward();
});
playPauseMinimized.addEventListener('click', (e) => {
  e.stopPropagation();
  e.preventDefault();
  togglePlayPause();
});
playPauseMinimized.addEventListener('touchend', (e) => {
  e.stopPropagation();
  e.preventDefault();
  togglePlayPause();
});
progressContainerExpanded.addEventListener('mousedown', (e) => {
  isDraggingExpanded = true;
  progressContainerExpanded.classList.add('dragging');
  updateProgressDrag(e.clientX, progressContainerExpanded, progressBarExpanded);
  e.stopPropagation();
});
document.addEventListener('mousemove', (e) => {
  if (isDraggingExpanded) {
    updateProgressDrag(e.clientX, progressContainerExpanded, progressBarExpanded);
  }
});
document.addEventListener('mouseup', () => {
  if (isDraggingExpanded) {
    isDraggingExpanded = false;
    progressContainerExpanded.classList.remove('dragging');
  }
});
progressContainerExpanded.addEventListener('touchstart', (e) => {
  isDraggingExpanded = true;
  progressContainerExpanded.classList.add('dragging');
  updateProgressDrag(e.touches[0].clientX, progressContainerExpanded, progressBarExpanded);
  e.preventDefault();
  e.stopPropagation();
});
document.addEventListener('touchmove', (e) => {
  if (isDraggingExpanded) {
    updateProgressDrag(e.touches[0].clientX, progressContainerExpanded, progressBarExpanded);
    e.preventDefault();
  }
});
document.addEventListener('touchend', () => {
  if (isDraggingExpanded) {
    isDraggingExpanded = false;
    progressContainerExpanded.classList.remove('dragging');
  }
});
progressContainerMinimized.addEventListener('mousedown', (e) => {
  isDraggingMinimized = true;
  progressContainerMinimized.classList.add('dragging');
  updateProgressDrag(e.clientX, progressContainerMinimized, progressBarMinimized);
  e.stopPropagation();
});
document.addEventListener('mousemove', (e) => {
  if (isDraggingMinimized) {
    updateProgressDrag(e.clientX, progressContainerMinimized, progressBarMinimized);
  }
});
document.addEventListener('mouseup', () => {
  if (isDraggingMinimized) {
    isDraggingMinimized = false;
    progressContainerMinimized.classList.remove('dragging');
  }
});
progressContainerMinimized.addEventListener('touchstart', (e) => {
  isDraggingMinimized = true;
  progressContainerMinimized.classList.add('dragging');
  updateProgressDrag(e.touches[0].clientX, progressContainerMinimized, progressBarMinimized);
  e.preventDefault();
  e.stopPropagation();
});
document.addEventListener('touchmove', (e) => {
  if (isDraggingMinimized) {
    updateProgressDrag(e.touches[0].clientX, progressContainerMinimized, progressBarMinimized);
    e.preventDefault();
  }
});
document.addEventListener('touchend', () => {
  if (isDraggingMinimized) {
    isDraggingMinimized = false;
    progressContainerMinimized.classList.remove('dragging');
  }
});
progressContainerFullscreen.addEventListener('mousedown', (e) => {
  isDraggingFullscreen = true;
  updateProgressDrag(e.clientX, progressContainerFullscreen, progressBarFullscreen);
});
progressContainerFullscreen.addEventListener('touchstart', (e) => {
  isDraggingFullscreen = true;
  updateProgressDrag(e.touches[0].clientX, progressContainerFullscreen, progressBarFullscreen);
  e.preventDefault();
});
document.addEventListener('mousemove', (e) => {
  if (isDraggingFullscreen) {
    updateProgressDrag(e.clientX, progressContainerFullscreen, progressBarFullscreen);
  }
});
document.addEventListener('touchmove', (e) => {
  if (isDraggingFullscreen) {
    updateProgressDrag(e.touches[0].clientX, progressContainerFullscreen, progressBarFullscreen);
    e.preventDefault();
  }
});
document.addEventListener('mouseup', () => {
  if (isDraggingFullscreen) isDraggingFullscreen = false;
});
document.addEventListener('touchend', () => {
  if (isDraggingFullscreen) isDraggingFullscreen = false;
});
playerExpanded.addEventListener('touchstart', (e) => {
  const target = e.target;
  if (target.closest('.media-container') || target.closest('.controls') || target.closest('.video-progress-container-expanded') || target.closest('.action-buttons') || target.closest('.episode-info') || target.closest('.panel-container') || target.closest('button')) {
    return;
  }
  touchStartY = e.touches[0].clientY;
  isSwiping = true;
});
playerExpanded.addEventListener('touchmove', (e) => {
  if (!isSwiping) return;
  touchEndY = e.touches[0].clientY;
});
playerExpanded.addEventListener('touchend', (e) => {
  if (!isSwiping) return;
  const deltaY = touchStartY - touchEndY;
  if (deltaY > swipeThreshold) {
    showMinimized();
  }
  isSwiping = false;
});
playerMinimized.addEventListener('touchstart', (e) => {
  if (e.target.closest('.minimized-controls') || progressContainerMinimized.contains(e.target)) {
    return;
  }
  touchStartY = e.touches[0].clientY;
  isSwiping = true;
});
playerMinimized.addEventListener('touchmove', (e) => {
  if (!isSwiping) return;
  touchEndY = e.touches[0].clientY;
});
playerMinimized.addEventListener('touchend', (e) => {
  if (!isSwiping) return;
  const deltaY = touchStartY - touchEndY;
  if (deltaY > swipeThreshold) {
    showExpanded();
  }
  isSwiping = false;
});
document.addEventListener('visibilitychange', () => {
  if (document.hidden && !isAudioMode && currentMedia?.mediaType === 'video') {
    mediaElement.pause();
    updateIcons(false);
    updateAllItemIcons(false);
  }
});
// Evitar que clics en el panel cierren o afecten al reproductor
panelContainer.addEventListener('click', (e) => {
  e.stopPropagation();
});
panelContainer.addEventListener('touchend', (e) => {
  e.stopPropagation();
});
window.addEventListener('load', () => {
  const programa = window.PROGRAMA_DEL_DIA || { title: 'Programa del Día' };
  document.querySelector('.full-width-btn span').textContent = programa.title;
  loadState();
  updatePlaylist();
  updateLikes();
  updateNextList();
  updateRecomendadosList();
  updateTextContent();
  checkTitleOverflow();
  checkMinimizedTitleOverflow();
});
window.addEventListener('popstate', () => {
  throttledSaveState();
  showMinimized();
});
window.addEventListener('beforeunload', throttledSaveState);
window.togglePlayer = () => {
  if (!currentMedia) {
    const programa = window.PROGRAMA_DEL_DIA || {
      mediaUrl: 'https://awscdn.podcasts.com/audio-vhhlggMJNysHnLYW8KXAQwu4w.mp3',
      mediaType: 'audio',
      coverUrlContainer: 'https://s3.amazonaws.com/podcasts-image-uploads/el-populismo-y-la-democracia-jesus-huerta-de-soto-1400x1400.png',
      coverUrlInfo: 'https://www.edu.balta.lat/web/image/415-8ae27244/media.png',
      title: 'El populismo y la democracia',
      detailUrl: '#',
      author: "Jesús Huerta de Soto",
      text: "No disponible",
      allowDownload: true
    };
    loadMedia(programa.mediaUrl, programa.mediaType, programa.coverUrlContainer, programa.coverUrlInfo, programa.title, programa.detailUrl, programa.author, [], programa.text, programa.allowDownload);
    togglePlayPause(true);
    throttledSaveState();
  } else {
    if (isHidden) {
      showMinimized();
    } else if (isExpanded) {
      showMinimized();
    } else {
      showExpanded();
    }
  }
};
window.playEpisode = (mediaUrl, mediaType = 'audio', coverUrlContainer = '', coverUrlInfo = '', title = '', detailUrl = '', author = 'Roberto', next = [], text = '', allowDownload = true) => {
  if (currentMedia && currentMedia.mediaUrl === mediaUrl && !mediaElement.paused) {
    togglePlayPause();
  } else {
    loadMedia(mediaUrl, mediaType, coverUrlContainer, coverUrlInfo, title, detailUrl, author, next, text, allowDownload);
    togglePlayPause(true);
    throttledSaveState();
  }
};
window.playEpisodeExpanded = (mediaUrl, mediaType = 'audio', coverUrlContainer = '', coverUrlInfo = '', title = '', detailUrl = '', author = 'Roberto', next = [], text = '', allowDownload = true) => {
  window.playEpisode(mediaUrl, mediaType, coverUrlContainer, coverUrlInfo, title, detailUrl, author, next, text, allowDownload);
  showExpanded();
};
// CORREGIDA: playExpanded - Ahora soporta episodios de RECOMENDADOS con orden
window.playExpanded = (episodioObj) => {
  if (!episodioObj) return;
  // Si es de RECOMENDADOS, mapea y busca index para continuar
  let mapped = episodioObj;
  let isFromRec = false;
  let recIndex = -1;
  if (episodioObj.type && !episodioObj.mediaType) {  // Detecta si es de recomendados
    mapped = mapEpisodeToMedia(episodioObj);
    recIndex = cachedRecomendados.findIndex(r => r.mediaUrl === episodioObj.mediaUrl);
    if (recIndex >= 0) isFromRec = true;
  }
  window.playEpisodeExpanded(
    mapped.mediaUrl || '',
    mapped.mediaType || 'audio',
    mapped.coverUrlContainer || '',
    mapped.coverUrlInfo || '',
    mapped.title || '',
    mapped.detailUrl || '',
    mapped.author || 'Roberto',
    mapped.next || [],
    mapped.text || '',
    mapped.allowDownload ?? true
  );
  // Si es de recomendados, ajusta en loadMedia via params extras
  if (isFromRec) {
    // Nota: loadMedia maneja isFromRecomendados y recIndex
  }
};
window.addToUserPlaylist = (obj) => {
  if (!obj || !obj.mediaUrl) return false;
  if (!playlist.some(p => p.mediaUrl === obj.mediaUrl)) {
    playlist.unshift(obj);
    localStorage.setItem('playlist', JSON.stringify(playlist));
    if (typeof updatePlaylist === 'function') updatePlaylist();
    if (typeof updateAddButton === 'function') updateAddButton();
    return true;
  }
  return false;
};
window.loadEpisode = loadMedia;
window.playEpisodeMinimized = (mediaUrl, mediaType = 'audio', coverUrlContainer = '', coverUrlInfo = '', title = '', detailUrl = '', author = 'Roberto', next = [], text = '', allowDownload = true) => {
  window.loadEpisode(
    mediaUrl,
    mediaType,
    coverUrlContainer,
    coverUrlInfo,
    title,
    detailUrl,
    author,
    next,
    text,
    allowDownload
  );
  togglePlayPause(true);
  showMinimized();
};
// === MEDIA SESSION API - PERSONALIZACIÓN DEFINITIVA ===
const updateMediaSession = () => {
  if (!('mediaSession' in navigator)) {
    console.log('[MediaSession] No soportada en este navegador');
    return;
  }
  if (!currentMedia || !mediaElement) {
    console.log('[MediaSession] Esperando currentMedia o mediaElement...');
    return;
  }
  console.log('[MediaSession] Actualizando con:', {
    title: currentMedia.title,
    artist: currentMedia.author,
    cover: currentMedia.coverUrlContainer
  });
  try {
    navigator.mediaSession.metadata = new MediaMetadata({
      title: currentMedia.title || 'Episodio sin título',
      artist: currentMedia.author || 'Roberto',
      album: 'By Balta',
      artwork: [
        { src: currentMedia.coverUrlContainer || 'https://via.placeholder.com/512?text=Cover', sizes: '512x512', type: 'image/png' },
        { src: currentMedia.coverUrlContainer || 'https://via.placeholder.com/256?text=Cover', sizes: '256x256', type: 'image/png' },
        { src: currentMedia.coverUrlContainer || 'https://via.placeholder.com/192?text=Cover', sizes: '192x192', type: 'image/png' }
      ]
    });
    console.log('[MediaSession] Metadata OK');
    navigator.mediaSession.setActionHandler('play', () => { togglePlayPause(true); });
    navigator.mediaSession.setActionHandler('pause', () => { togglePlayPause(); });
    navigator.mediaSession.setActionHandler('previoustrack', previous);
    navigator.mediaSession.setActionHandler('nexttrack', next);
    navigator.mediaSession.setActionHandler('seekbackward', () => rewind(15));
    navigator.mediaSession.setActionHandler('seekforward', () => forward(15));
    if (!isNaN(mediaElement.duration)) {
      navigator.mediaSession.setPositionState({
        duration: mediaElement.duration,
        playbackRate: mediaElement.playbackRate || 1,
        position: mediaElement.currentTime || 0
      });
    }
  } catch (err) {
    console.error('[MediaSession] Error:', err.message);
  }
};
// Integración automática
mediaElement.addEventListener('play', updateMediaSession);
mediaElement.addEventListener('pause', updateMediaSession);
mediaElement.addEventListener('loadedmetadata', updateMediaSession);
mediaElement.addEventListener('timeupdate', () => {
  if ('mediaSession' in navigator && !isNaN(mediaElement.duration)) {
    navigator.mediaSession.setPositionState({
      duration: mediaElement.duration,
      playbackRate: mediaElement.playbackRate || 1,
      position: mediaElement.currentTime || 0
    });
  }
});
// Limpieza opcional
window.addEventListener('beforeunload', () => {
  if ('mediaSession' in navigator) {
    navigator.mediaSession.metadata = null;
  }
});
</script>
  
</body>
</html>
